{% extends "base.html" %}

{% block title %}Session Reminders - EduOps360{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6">
    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold gradient-text mb-2">Session Reminders</h1>
                    <p class="text-slate-600">Send automated reminders for upcoming live sessions</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="glass rounded-xl px-4 py-2">
                        <span class="text-sm text-slate-600">Today:</span>
                        <span class="font-semibold text-slate-800" id="current-date"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        <div id="flash-messages" class="mb-6"></div>

        <!-- File Information Card -->
        <div id="file-info-card" class="glass rounded-2xl p-6 mb-6 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-file-excel text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-slate-800">Currently Loaded File</h3>
                        <p class="text-sm text-slate-600" id="file-name">No file loaded</p>
                        <p class="text-xs text-slate-500" id="file-upload-date"></p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-center">
                        <p class="text-sm text-slate-600">Professors</p>
                        <p class="text-lg font-bold text-blue-600" id="file-professors-count">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-slate-600">Sessions</p>
                        <p class="text-lg font-bold text-orange-600" id="file-sessions-count">0</p>
                    </div>
                    <button onclick="clearAllData()" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium">
                        <i class="fas fa-trash mr-2"></i>Clear Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass rounded-2xl p-6 hover:shadow-lg transition-all duration-300">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-600 text-sm font-medium">Professors</p>
                        <p class="text-3xl font-bold text-blue-600" id="professor-count">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-chalkboard-teacher text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="glass rounded-2xl p-6 hover:shadow-lg transition-all duration-300">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-600 text-sm font-medium">Sessions</p>
                        <p class="text-3xl font-bold text-orange-600" id="session-count">0</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-clock text-orange-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="glass rounded-2xl p-6 hover:shadow-lg transition-all duration-300">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-600 text-sm font-medium">Emails Sent</p>
                        <p class="text-3xl font-bold text-green-600" id="email-sent">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-paper-plane text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="glass rounded-2xl p-6 hover:shadow-lg transition-all duration-300">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-600 text-sm font-medium">Errors</p>
                        <p class="text-3xl font-bold text-red-600" id="error-count">0</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <!-- Upload Section -->
            <div class="glass rounded-2xl p-8 hover:shadow-lg transition-all duration-300">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-file-excel text-blue-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800">Upload Excel File</h2>
                </div>
                
                <div class="border-2 border-dashed border-blue-300 rounded-xl p-8 text-center mb-6 hover:border-blue-400 transition-colors duration-300" id="drop-zone">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-cloud-upload-alt text-blue-600 text-2xl"></i>
                    </div>
                    <p class="text-slate-600 mb-4">Drag & drop your Excel file here or click to browse</p>
                    <button class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 transition-all duration-300 shadow-lg hover:shadow-xl" id="browse-btn">
                        <i class="fas fa-search mr-2"></i>Browse Files
                    </button>
                    <input type="file" id="file-input" class="hidden" accept=".xlsx,.xls">
                    <p class="text-sm text-slate-500 mt-3" id="file-name">No file selected</p>
                </div>
                
                <div class="flex gap-4">
                    <button class="flex-1 bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-purple-700 transition-all duration-300 shadow-lg hover:shadow-xl" id="sample-excel-btn">
                        <i class="fas fa-download mr-2"></i>Sample Excel
                    </button>
                    <button class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-red-600 hover:to-red-700 transition-all duration-300 shadow-lg hover:shadow-xl" id="reset-btn">
                        <i class="fas fa-trash mr-2"></i>Reset
                    </button>
                </div>
            </div>

            <!-- Email Actions Section -->
            <div class="glass rounded-2xl p-8 hover:shadow-lg transition-all duration-300">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-envelope text-green-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800">Email Actions</h2>
                </div>
                
                <!-- Email Account Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-slate-700 mb-3">Select Email Account</label>
                    <select id="email-account-select" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                        {% for account in email_accounts %}
                        <option value="{{ account.key }}">{{ account.email }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Recipient Type Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-slate-700 mb-3">Send Reminders To</label>
                    <div class="grid grid-cols-1 gap-3">
                        <label class="flex items-center p-4 border border-slate-300 rounded-xl cursor-pointer hover:bg-blue-50 transition-colors duration-300">
                            <input type="radio" name="recipient-type" value="professors" class="mr-3 text-blue-600" checked>
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-chalkboard-teacher text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-slate-800">Professors</p>
                                    <p class="text-sm text-slate-600">Send reminders directly to professors</p>
                                </div>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 border border-slate-300 rounded-xl cursor-pointer hover:bg-green-50 transition-colors duration-300">
                            <input type="radio" name="recipient-type" value="learners" class="mr-3 text-green-600">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-user-graduate text-green-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-slate-800">Learners</p>
                                    <p class="text-sm text-slate-600">Send cohort-specific emails to akshit1.shetty@upgrad.com for forwarding to students</p>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-4 mb-6">
                    <button class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition-all duration-300 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed" id="send-btn" disabled>
                        <i class="fas fa-paper-plane mr-2"></i>Send Emails
                    </button>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                    <div class="bg-gradient-to-r from-green-500 to-green-600 h-full rounded-full transition-all duration-500 ease-out" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Professors & Sessions Table -->
        <div class="glass rounded-2xl p-8 hover:shadow-lg transition-all duration-300">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-list text-purple-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">Professors & Sessions</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-slate-200">
                            <th class="text-left py-4 px-4 font-semibold text-slate-700">Professor</th>
                            <th class="text-left py-4 px-4 font-semibold text-slate-700">Email</th>
                            <th class="text-left py-4 px-4 font-semibold text-slate-700">Sessions</th>
                            <th class="text-left py-4 px-4 font-semibold text-slate-700">Status</th>
                            <th class="text-left py-4 px-4 font-semibold text-slate-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="professor-table-body">
                        <tr>
                            <td colspan="5" class="text-center py-12 text-slate-500">
                                <div class="flex flex-col items-center gap-3">
                                    <i class="fas fa-inbox text-4xl text-slate-300"></i>
                                    <p>No data available. Please upload an Excel file.</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden items-center justify-center z-50" id="preview-modal">
    <div class="glass rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-800">Email Preview</h2>
            <button class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center hover:bg-red-200 transition-colors duration-300" id="close-preview">
                <i class="fas fa-times text-red-600"></i>
            </button>
        </div>
        
        <!-- Preview Type Selector -->
        <div class="mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
            <label class="block text-sm font-semibold text-slate-700 mb-3">Preview Email Format</label>
            <div class="flex gap-4">
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="preview-type" value="professors" class="mr-2 text-blue-600" checked>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chalkboard-teacher text-blue-600 text-xs"></i>
                        </div>
                        <span class="text-sm font-medium text-slate-700">Professor Email</span>
                    </div>
                </label>
                
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="preview-type" value="learners" class="mr-2 text-green-600">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-user-graduate text-green-600 text-xs"></i>
                        </div>
                        <span class="text-sm font-medium text-slate-700">Learner Email</span>
                    </div>
                </label>
            </div>
        </div>
        
        <div id="email-preview-content" class="prose max-w-none"></div>
    </div>
</div>

<script>
// Set current date
function setCurrentDate() {
    const now = new Date();
    const options = { day: '2-digit', month: 'long', year: 'numeric' };
    const formattedDate = now.toLocaleDateString('en-US', options);
    document.getElementById('current-date').textContent = formattedDate;
}

// DOM Elements
const fileInput = document.getElementById("file-input");
const browseBtn = document.getElementById("browse-btn");
const dropZone = document.getElementById("drop-zone");
const fileName = document.getElementById("file-name");
// Load button removed - auto-loading implemented
const resetBtn = document.getElementById("reset-btn");
const sampleExcelBtn = document.getElementById("sample-excel-btn");
const sendBtn = document.getElementById("send-btn");
const emailAccountSelect = document.getElementById("email-account-select");

const professorTableBody = document.getElementById("professor-table-body");
const flashMessages = document.getElementById("flash-messages");
const progressFill = document.getElementById("progress-fill");
const previewModal = document.getElementById("preview-modal");
const closePreview = document.getElementById("close-preview");
const emailPreviewContent = document.getElementById("email-preview-content");

// Stats elements
const professorCountEl = document.getElementById("professor-count");
const sessionCountEl = document.getElementById("session-count");
const emailSentEl = document.getElementById("email-sent");
const errorCountEl = document.getElementById("error-count");

let selectedFile = null;

// Event Listeners
browseBtn.addEventListener("click", () => fileInput.click());
fileInput.addEventListener("change", handleFileSelect);
resetBtn.addEventListener("click", resetData);
sampleExcelBtn.addEventListener("click", downloadSampleExcel);
sendBtn.addEventListener("click", () => sendEmails(false));
closePreview.addEventListener("click", () => {
    previewModal.classList.add("hidden");
    previewModal.classList.remove("flex");
    
    // Reset preview type to professors (default)
    const professorsRadio = document.querySelector('input[name="preview-type"][value="professors"]');
    if (professorsRadio) {
        professorsRadio.checked = true;
    }
    
    // Clear stored email
    delete previewModal.dataset.currentEmail;
});

// Drag and drop handlers
dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("border-blue-400", "bg-blue-50");
});

dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("border-blue-400", "bg-blue-50");
});

dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("border-blue-400", "bg-blue-50");
    
    if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileSelect(e);
    }
});

// File selection handler
function handleFileSelect(e) {
    const file = e.target.files[0] || e.dataTransfer.files[0];
    
    if (file) {
        if (file.name.endsWith(".xlsx") || file.name.endsWith(".xls")) {
            selectedFile = file;
            fileName.textContent = file.name;
            showFlashMessage("File selected successfully. Loading sessions automatically...", "info");
            
            // Automatically load sessions after file selection
            setTimeout(() => {
                loadSessions();
            }, 500); // Small delay to show the success message
        } else {
            showFlashMessage("Please select an Excel file (.xlsx or .xls).", "error");
        }
    }
}

// Load sessions from file
function loadSessions() {
    if (!selectedFile) {
        showFlashMessage("Please select an Excel file first.", "error");
        return;
    }
    
    const formData = new FormData();
    formData.append("file", selectedFile);
    
    showFlashMessage("Processing Excel file and loading sessions...", "info");
    
    fetch("/reminder/api/upload-excel", {
        method: "POST",
        body: formData,
    })
    .then((response) => {
        console.log("Response status:", response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then((data) => {
        console.log("Upload response:", data);
        if (data.success) {
            showFlashMessage(data.message, "success");
            sendBtn.disabled = false;
            updateStats();
            updateProfessorTable();
            loadFileInfo(); // Refresh file info after successful upload
        } else {
            showFlashMessage("Error: " + data.error, "error");
        }
    })
    .catch((error) => {
        console.error("Error:", error);
        showFlashMessage("Failed to load sessions: " + error.message, "error");
    });
}

// Send emails
function sendEmails(previewOnly) {
    const recipientType = document.querySelector('input[name="recipient-type"]:checked').value;
    const emailAccount = emailAccountSelect.value;
    
    console.log("Sending emails with:", { previewOnly, recipientType, emailAccount });
    
    fetch("/reminder/api/send-emails", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ 
            preview: previewOnly, 
            recipient_type: recipientType,
            email_account: emailAccount
        }),
    })
    .then((response) => {
        console.log("Send emails response status:", response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then((data) => {
        console.log("Send emails response:", data);
        if (data.success) {
            const message = previewOnly
                ? "Generating email previews..."
                : "Email sending process started! Check the progress below.";
            showFlashMessage(message, "success");
            
            // Start real-time polling for updates if not preview
            if (!previewOnly) {
                startRealTimePolling();
            }
            
            updateProfessorTable();
        } else {
            showFlashMessage("Error: " + data.error, "error");
        }
    })
    .catch((error) => {
        console.error("Error:", error);
        showFlashMessage("Failed to start email sending: " + error.message, "error");
    });
}

// Poll email status
function pollEmailStatus() {
    const interval = setInterval(() => {
        fetch("/reminder/api/email-status")
            .then((response) => response.json())
            .then((status) => {
                updateEmailStatusTable(status);
                updateStats();
                
                // Check if all emails are processed
                const allProcessed = Object.values(status).every(
                    (s) => s.status !== "pending"
                );
                
                if (allProcessed) {
                    clearInterval(interval);
                    showFlashMessage("All emails have been processed.", "success");
                }
            })
            .catch((error) => {
                console.error("Error polling status:", error);
                clearInterval(interval);
            });
    }, 2000);
}

// Reset data
function resetData() {
    fetch("/reminder/api/reset", {
        method: "POST",
    })
    .then((response) => response.json())
    .then((data) => {
        if (data.success) {
            selectedFile = null;
            fileInput.value = "";
            fileName.textContent = "No file selected";
            sendBtn.disabled = true;
            professorTableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-12 text-slate-500">
                        <div class="flex flex-col items-center gap-3">
                            <i class="fas fa-inbox text-4xl text-slate-300"></i>
                            <p>No data available. Please upload an Excel file.</p>
                        </div>
                    </td>
                </tr>
            `;
            updateStats();
            showFlashMessage("Data reset successfully.", "success");
        }
    })
    .catch((error) => {
        console.error("Error:", error);
        showFlashMessage("Failed to reset data: " + error.message, "error");
    });
}

// Update professor table with real-time status
function updateProfessorTable() {
    fetch("/reminder/api/email-status")
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                updateEmailStatusTable(data.email_status);
                updateProgressBar(data.progress);
            }
        })
        .catch((error) => {
            console.error("Error fetching email status:", error);
        });
}

// Update progress bar with real-time data
function updateProgressBar(progress) {
    if (progress) {
        const progressFill = document.getElementById("progress-fill");
        const progressText = document.querySelector(".progress-text");
        
        if (progressFill) {
            progressFill.style.width = `${progress.percentage}%`;
        }
        
        if (progressText) {
            progressText.textContent = `${progress.sent + progress.error}/${progress.total} emails processed (${progress.percentage}%)`;
        }
        
        // Update stats cards
        const professorCountEl = document.getElementById("professor-count");
        const emailSentEl = document.getElementById("emails-sent");
        const errorCountEl = document.getElementById("error-count");
        
        if (professorCountEl) professorCountEl.textContent = progress.total;
        if (emailSentEl) emailSentEl.textContent = progress.sent;
        if (errorCountEl) errorCountEl.textContent = progress.error;
    }
}

function updateEmailStatusTable(status) {
    fetch("/reminder/api/stats")
        .then((response) => response.json())
        .then((stats) => {
            professorCountEl.textContent = stats.professors;
            sessionCountEl.textContent = stats.sessions;
            emailSentEl.textContent = stats.emails_sent;
            errorCountEl.textContent = stats.errors;
            
            // Calculate progress
            const total = stats.professors;
            const completed = stats.emails_sent + stats.errors;
            const progress = total > 0 ? (completed / total) * 100 : 0;
            progressFill.style.width = `${progress}%`;
        })
        .catch((error) => {
            console.error("Error fetching stats:", error);
        });
    
    // Update the table with professor data
    fetch("/reminder/api/upload-excel", {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
        },
    })
    .then((response) => response.json())
    .then((data) => {
        if (data.success && data.sessions && data.sessions.length > 0) {
            // Enable send button when data is available
            sendBtn.disabled = false;
            
            let tableHTML = "";
            
            data.sessions.forEach((professor) => {
                const emailStatus = status[professor.email] || {
                    status: "pending",
                    message: "Not sent yet",
                };
                
                const statusColors = {
                    pending: "bg-yellow-100 text-yellow-800",
                    sent: "bg-green-100 text-green-800",
                    error: "bg-red-100 text-red-800",
                    preview: "bg-blue-100 text-blue-800"
                };
                
                const statusClass = statusColors[emailStatus.status] || "bg-gray-100 text-gray-800";
                
                tableHTML += `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors duration-200">
                        <td class="py-4 px-4 font-medium text-slate-800">${professor.professor}</td>
                        <td class="py-4 px-4 text-slate-600">${professor.email}</td>
                        <td class="py-4 px-4 text-slate-600">${professor.sessions.length} session(s)</td>
                        <td class="py-4 px-4">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
                                ${emailStatus.status}
                            </span>
                            <p class="text-xs text-slate-500 mt-1">${emailStatus.message}</p>
                        </td>
                        <td class="py-4 px-4">
                            <button class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:from-blue-600 hover:to-blue-700 transition-all duration-300 shadow-md hover:shadow-lg" onclick="previewEmail('${professor.email}')">
                                <i class="fas fa-eye mr-1"></i> Preview
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            professorTableBody.innerHTML = tableHTML;
        } else {
            // No data available - keep button disabled and show empty state
            sendBtn.disabled = true;
            professorTableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-12 text-slate-500">
                        <div class="flex flex-col items-center gap-3">
                            <i class="fas fa-inbox text-4xl text-slate-300"></i>
                            <p>No data available. Please upload an Excel file.</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    })
    .catch((error) => {
        console.error("Error fetching sessions:", error);
    });
}

// Preview email
function previewEmail(email) {
    // Get the selected preview type (default to professors)
    const previewType = document.querySelector('input[name="preview-type"]:checked')?.value || 'professors';
    
    fetch(`/reminder/api/preview-email/${encodeURIComponent(email)}?type=${previewType}`)
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                emailPreviewContent.innerHTML = data.preview;
                previewModal.classList.remove("hidden");
                previewModal.classList.add("flex");
                
                // Store current email for preview type switching
                previewModal.dataset.currentEmail = email;
                
                // Add event listeners for preview type radio buttons
                setupPreviewTypeListeners();
            } else {
                showFlashMessage("Error: " + data.error, "error");
            }
        })
        .catch((error) => {
            console.error("Error fetching preview:", error);
            showFlashMessage("Failed to generate preview: " + error.message, "error");
        });
}

// Setup preview type radio button listeners
function setupPreviewTypeListeners() {
    const previewTypeRadios = document.querySelectorAll('input[name="preview-type"]');
    
    previewTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const currentEmail = previewModal.dataset.currentEmail;
            if (currentEmail) {
                // Fetch new preview with selected type
                const selectedType = this.value;
                
                fetch(`/reminder/api/preview-email/${encodeURIComponent(currentEmail)}?type=${selectedType}`)
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            emailPreviewContent.innerHTML = data.preview;
                        } else {
                            showFlashMessage("Error: " + data.error, "error");
                        }
                    })
                    .catch((error) => {
                        console.error("Error fetching preview:", error);
                        showFlashMessage("Failed to update preview: " + error.message, "error");
                    });
            }
        });
    });
}

// Update stats
function updateStats() {
    fetch("/reminder/api/stats")
        .then((response) => response.json())
        .then((stats) => {
            professorCountEl.textContent = stats.professors;
            sessionCountEl.textContent = stats.sessions;
            emailSentEl.textContent = stats.emails_sent;
            errorCountEl.textContent = stats.errors;
            
            // Calculate progress
            const total = stats.professors;
            const completed = stats.emails_sent + stats.errors;
            const progress = total > 0 ? (completed / total) * 100 : 0;
            progressFill.style.width = `${progress}%`;
        })
        .catch((error) => {
            console.error("Error fetching stats:", error);
        });
}

// Show flash message
function showFlashMessage(message, type) {
    const messageDiv = document.createElement("div");
    
    const colors = {
        success: "bg-green-100 border-green-500 text-green-700",
        error: "bg-red-100 border-red-500 text-red-700",
        info: "bg-blue-100 border-blue-500 text-blue-700",
        warning: "bg-yellow-100 border-yellow-500 text-yellow-700"
    };
    
    const icons = {
        success: "fas fa-check-circle",
        error: "fas fa-exclamation-circle",
        info: "fas fa-info-circle",
        warning: "fas fa-exclamation-triangle"
    };
    
    messageDiv.className = `border-l-4 p-4 rounded-r-lg ${colors[type]} mb-4 flex items-center gap-3 animate-pulse`;
    messageDiv.innerHTML = `
        <i class="${icons[type]}"></i>
        <span>${message}</span>
        <button class="ml-auto text-xl hover:opacity-70" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    flashMessages.appendChild(messageDiv);
    
    // Auto dismiss after 5 seconds for non-error messages
    if (type !== "error") {
        setTimeout(() => {
            if (messageDiv.parentElement) {
                messageDiv.remove();
            }
        }, 5000);
    }
}

// Load file information on page load
function loadFileInfo() {
    fetch("/reminder/api/file-info")
        .then(response => response.json())
        .then(data => {
            if (data.success && data.file_info) {
                const fileInfo = data.file_info;
                document.getElementById("file-name").textContent = fileInfo.original_filename;
                document.getElementById("file-upload-date").textContent = `Uploaded: ${new Date(fileInfo.upload_date).toLocaleString()}`;
                document.getElementById("file-professors-count").textContent = fileInfo.professors_count;
                document.getElementById("file-sessions-count").textContent = fileInfo.sessions_count;
                document.getElementById("file-info-card").classList.remove("hidden");
                
                // Enable button if data is loaded
                if (fileInfo.professors_count > 0) {
                    sendBtn.disabled = false;
                    updateProfessorTable();
                }
            } else {
                document.getElementById("file-info-card").classList.add("hidden");
            }
        })
        .catch(error => {
            console.error("Error loading file info:", error);
        });
}

// Download sample Excel file
function downloadSampleExcel() {
    try {
        showFlashMessage("Downloading sample Excel file...", "info");
        
        // Create a temporary link element to trigger download
        const link = document.createElement('a');
        link.href = '/reminder/api/download-sample-excel';
        link.download = 'sample_sessions.xlsx';
        link.style.display = 'none';
        
        // Add to document, click, and remove
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show success message after a short delay
        setTimeout(() => {
            showFlashMessage("Sample Excel file downloaded successfully! Use this template for your session data.", "success");
        }, 1000);
        
    } catch (error) {
        console.error("Error downloading sample Excel:", error);
        showFlashMessage("Failed to download sample Excel: " + error.message, "error");
    }
}

// Clear all persistent data
function clearAllData() {
    if (confirm("Are you sure you want to clear all reminder data? This will permanently delete the uploaded file and all session information.")) {
        fetch("/reminder/api/reset", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showFlashMessage(data.message, "success");
                
                // Reset UI
                document.getElementById("file-info-card").classList.add("hidden");
                sendBtn.disabled = true;
                selectedFile = null;
                fileName.textContent = "No file selected";
                
                // Clear table
                professorTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-12 text-slate-500">
                            <div class="flex flex-col items-center gap-3">
                                <i class="fas fa-inbox text-4xl text-slate-300"></i>
                                <p>No data available. Please upload an Excel file.</p>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Reset stats
                updateStats();
            } else {
                showFlashMessage("Error: " + data.error, "error");
            }
        })
        .catch(error => {
            console.error("Error clearing data:", error);
            showFlashMessage("Failed to clear data: " + error.message, "error");
        });
    }
}

// Real-time polling for email status updates
let pollingInterval = null;

function startRealTimePolling() {
    console.log("🔄 Starting real-time polling for email status updates");
    
    // Clear any existing polling
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    
    // Poll every 2 seconds during email sending
    pollingInterval = setInterval(() => {
        updateProfessorTable();
        
        // Check if all emails are processed (sent or error)
        fetch("/reminder/api/email-status")
            .then(response => response.json())
            .then(data => {
                if (data.success && data.progress) {
                    const { total, sent, error } = data.progress;
                    
                    // Stop polling when all emails are processed
                    if (sent + error >= total && total > 0) {
                        console.log("✅ All emails processed, stopping polling");
                        stopRealTimePolling();
                        showFlashMessage(`Email sending completed! Sent: ${sent}, Errors: ${error}`, sent > error ? "success" : "warning");
                    }
                }
            })
            .catch(error => {
                console.error("Polling error:", error);
            });
    }, 2000); // Poll every 2 seconds
}

function stopRealTimePolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log("⏹️ Stopped real-time polling");
    }
}

// Initialize
setCurrentDate();
updateStats();
loadFileInfo(); // Load persistent data on page load
updateProfessorTable(); // Load professor data on page load
</script>

{% endblock %}

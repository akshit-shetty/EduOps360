{% extends "base.html" %}

{% block title %}Bulk Document Generator | Professional Tool{% endblock %}

{% block content %}
<div class="app-container">
  <!-- Header Section -->
  <div class="page-header">
    <h1><i class="fas fa-file-contract"></i> Bulk Document Generator</h1>
    <div class="last-updated">Professional document automation tool</div>
  </div>

  <!-- Progress Steps -->
  <div class="card progress-card">
    <div class="progress-tracker">
      <div class="progress-bar" id="progress-bar"></div>
      <div class="step-indicators">
        <div class="step-item active" id="step-1-indicator">
          <div class="step-bubble">1</div>
          <div class="step-label">Template</div>
        </div>
        <div class="step-item" id="step-2-indicator">
          <div class="step-bubble">2</div>
          <div class="step-label">Data</div>
        </div>
        <div class="step-item" id="step-3-indicator">
          <div class="step-bubble">3</div>
          <div class="step-label">Preview</div>
        </div>
        <div class="step-item" id="step-4-indicator">
          <div class="step-bubble">4</div>
          <div class="step-label">Generate</div>
        </div>
      </div>
    </div>
  </div>

  <div class="app-content">
    <!-- Left Side - Template and Data -->
    <div class="main-content-area">
      <!-- Template Example Card -->
      <div class="card template-card">
        <div class="card-header">
          <div class="card-title">Template Example</div>
          <div class="card-icon">
            <i class="fas fa-lightbulb"></i>
          </div>
        </div>
        <div class="card-content">
          <p>Your template should follow this format:</p>
          <div class="code-block">
            <pre>Date: {Today}

Dear Sir/Madam,

LETTER OF INTRODUCTION FOR VISA APPLICATION

The applicant for the visa, {Full_Name} of {Nationality} 
nationality, holder of passport no. {Passport_Number} is 
coming to Singapore from {Country} for the purpose of 
attending a workshop.</pre>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Side - Upload Cards (Now in a single row) -->
    <div class="upload-cards-container">
      <!-- Template Upload Card -->
      <div class="card template-upload-card">
        <div class="card-header">
          <div class="card-title">Template Document</div>
          <div class="card-icon">
            <i class="fas fa-file-word"></i>
          </div>
        </div>

        <div class="card-content">
          <div class="info-banner">
            <i class="fas fa-info-circle"></i>
            <div>
              <strong>Template Format</strong>
              <p>Use placeholders like <code>{Field_Name}</code> that match your CSV column headers</p>
            </div>
          </div>

          <div class="upload-area" id="template-upload-area">
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="upload-text">
              <h3>Upload Word Template</h3>
              <p>DOCX format only</p>
            </div>
            <button class="btn btn-primary upload-btn">
              <i class="fas fa-upload"></i> Select File
            </button>
            <input type="file" id="template-file" accept=".docx" />
          </div>

          <div id="template-analysis" class="hidden">
            <div class="status-card">
              <div class="status-icon">
                <i class="fas fa-search"></i>
              </div>
              <div class="status-content">
                <h4>Template Analyzed</h4>
                <p>Found <span id="placeholder-count">0</span> placeholders</p>
              </div>
            </div>

            <div class="placeholder-section">
              <h5>Detected placeholders:</h5>
              <div class="placeholder-tags" id="placeholder-items"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Data Source Card -->
      <div class="card data-source-card">
        <div class="card-header">
          <div class="card-title">Data Source</div>
          <div class="card-icon">
            <i class="fas fa-database"></i>
          </div>
        </div>

        <div class="card-content">
          <div class="upload-area" id="data-upload-area">
            <div class="upload-icon">
              <i class="fas fa-file-csv"></i>
            </div>
            <div class="upload-text">
              <h3>Upload CSV Data</h3>
              <p>With column headers</p>
            </div>
            <button class="btn btn-primary upload-btn">
              <i class="fas fa-upload"></i> Select File
            </button>
            <input type="file" id="data-file" accept=".csv" />
          </div>

          <div id="data-status" class="hidden">
            <div class="status-card">
              <div class="status-icon success">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="status-content">
                <h4><span id="record-count">0</span> Records Imported</h4>
                <p>CSV file parsed successfully</p>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <label for="date-format">Date Format:</label>
            <select id="date-format" class="select-input">
              <option value="YYYY-MM-DD">YYYY-MM-DD (2023-12-31)</option>
              <option value="DD/MM/YYYY">DD/MM/YYYY (31/12/2023)</option>
              <option value="MM/DD/YYYY">MM/DD/YYYY (12/31/2023)</option>
              <option value="DD MMM YYYY">DD MMM YYYY (31 Dec 2023)</option>
              <option value="DD MMMM YYYY" selected>
                DD MMMM YYYY (31 December 2023)
              </option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Section - Preview and Actions -->
    <div class="main-content-area">
      <!-- Document Preview Card -->
      <div class="card preview-card">
        <div class="card-header">
          <div class="card-title">Document Preview</div>
          <div class="card-icon">
            <i class="fas fa-file-alt"></i>
          </div>
        </div>

        <div class="card-description">
          Preview how your generated document will appear with the provided data
        </div>

        <div class="document-preview" id="document-view">
          <div class="preview-placeholder">
            <i class="fas fa-file-alt"></i>
            <h3>No template uploaded</h3>
            <p>Upload a Word template and CSV data to see a preview</p>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" id="generate-btn" disabled>
            <i class="fas fa-cogs"></i> Generate All Documents
          </button>
          <button class="btn btn-secondary" id="reset-btn">
            <i class="fas fa-redo"></i> Start Over
          </button>
        </div>

        <!-- Progress Bar Container -->
        <div id="progress-container" class="progress-container hidden">
          <div class="progress-header">
            <h3><i class="fas fa-cogs"></i> Generating Documents</h3>
            <p>
              Processing <span id="current-doc-number">0</span> of
              <span id="total-docs">0</span> documents
            </p>
          </div>
          <div class="progress-track">
            <div class="progress-fill" id="progress-bar-fill"></div>
          </div>
          <div class="progress-details">
            <span id="progress-percentage">0%</span>
            <span id="current-file">Initializing...</span>
          </div>
          <button class="btn btn-secondary" id="cancel-btn">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>

        <div id="success-message" class="success-message hidden">
          <div class="success-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="success-content">
            <h4>Documents Generated Successfully!</h4>
            <p>Your files are ready for download</p>

            <div class="download-options">
              <button class="btn btn-primary" id="download-word-btn">
                <i class="fas fa-file-word"></i> Download Word
              </button>
              <button class="btn btn-primary" id="download-pdf-btn">
                <i class="fas fa-file-pdf"></i> Download PDF
              </button>
              <button class="btn btn-primary" id="email-btn">
                <i class="fas fa-envelope"></i> Send Bulk Email
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Modern Design System - Dark Mode Compatible */
  :root {
    --primary: #4361ee;
    --primary-dark: #3a56d4;
    --primary-light: #eef2ff;
    --secondary: #0e9f6e;
    --secondary-light: #def7ec;
    --danger: #f05252;
    --danger-light: #fde8e8;
    --warning: #faca15;
    --warning-light: #fdf6b2;
    --info: #3f83f8;
    --info-light: #e1effe;
    --dark: #1f2d3d;
    --dark-light: #6b7280;
    --light: #f9fafb;
    --white: #ffffff;
    --border-radius: 12px;
    --border-radius-sm: 8px;
    --border-radius-lg: 16px;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --transition: all 0.3s ease;
  }

  .dark-mode {
    --primary-light: rgba(67, 97, 238, 0.15);
    --secondary-light: rgba(14, 159, 110, 0.15);
    --danger-light: rgba(240, 82, 82, 0.15);
    --warning-light: rgba(250, 202, 21, 0.15);
    --info-light: rgba(63, 131, 248, 0.15);
    --light: #1a243a;
    --white: #243043;
    --dark: #f8f9fa;
    --dark-light: #a3adc5;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.25),
      0 2px 4px -1px rgba(0, 0, 0, 0.2);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3),
      0 4px 6px -2px rgba(0, 0, 0, 0.25);
  }

  .app-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
  }

  /* Header Styles */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding: 0 8px;
  }

  .page-header h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .page-header h1 i {
    color: var(--primary);
  }

  .last-updated {
    font-size: 14px;
    color: var(--dark-light);
    font-weight: 500;
  }

  /* Layout */
  .app-content {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  /* NEW: Upload cards container for side-by-side layout */
  .upload-cards-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
    margin-bottom: 24px;
  }

  /* Ensure cards have equal height */
  .upload-cards-container>.card {
    display: flex;
    flex-direction: column;
    height: auto;
  }

  .card-content {
    flex: 1;
  }

  /* Card Styles */
  .card {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow);
    margin-bottom: 24px;
    overflow: hidden;
    transition: var(--transition);
    border: 1px solid var(--gray-200);
  }

  .card:hover {
    box-shadow: var(--shadow-lg);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--gray-200);
  }

  .card-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--dark);
  }

  .card-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    background: var(--primary-light);
    color: var(--primary);
    font-size: 16px;
  }

  .card-content {
    padding: 24px;
  }

  .card-description {
    padding: 0 24px 16px;
    color: var(--dark-light);
    font-size: 14px;
  }

  /* Template Example Card */
  .template-card .code-block {
    background: var(--gray-100);
    border-radius: var(--border-radius-sm);
    padding: 16px;
    margin-top: 12px;
    overflow-x: auto;
  }

  .template-card pre {
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
    font-size: 13px;
    line-height: 1.5;
    color: var(--dark);
    margin: 0;
    white-space: pre-wrap;
  }

  /* Info Banner */
  .info-banner {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    background: var(--info-light);
    color: var(--info);
    padding: 16px;
    border-radius: var(--border-radius-sm);
    margin-bottom: 20px;
    border-left: 4px solid var(--info);
  }

  .info-banner i {
    font-size: 18px;
    margin-top: 2px;
  }

  .info-banner strong {
    display: block;
    margin-bottom: 4px;
  }

  .info-banner p {
    margin: 0;
    font-size: 14px;
  }

  .info-banner code {
    background: rgba(255, 255, 255, 0.7);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 13px;
  }

  /* Upload Area */
  .upload-area {
    border: 2px dashed var(--gray-300);
    border-radius: var(--border-radius);
    padding: 32px 24px;
    text-align: center;
    margin-bottom: 20px;
    background: var(--light);
    transition: var(--transition);
    cursor: pointer;
    position: relative;
  }

  .upload-area:hover {
    border-color: var(--primary);
    background: var(--primary-light);
  }

  .upload-area.active {
    border-color: var(--primary);
    background: var(--primary-light);
  }

  .upload-area input[type="file"] {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    opacity: 0;
    cursor: pointer;
  }

  .upload-icon {
    font-size: 42px;
    color: var(--primary);
    margin-bottom: 16px;
  }

  .upload-text h3 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--dark);
  }

  .upload-text p {
    font-size: 14px;
    color: var(--dark-light);
    margin-bottom: 16px;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: var(--border-radius-sm);
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: var(--transition);
    border: none;
    outline: none;
  }

  .btn-primary {
    background: var(--primary);
    color: var(--white);
  }

  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .btn-primary:disabled {
    background: var(--dark-light);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .btn-secondary {
    background: var(--white);
    color: var(--dark);
    border: 1px solid var(--gray-300);
  }

  .btn-secondary:hover {
    background: var(--light);
    border-color: var(--primary-light);
  }

  .upload-btn {
    padding: 10px 16px;
    font-size: 13px;
  }

  /* Status Card */
  .status-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--light);
    border-radius: var(--border-radius);
    margin-bottom: 16px;
  }

  .status-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    background: var(--primary-light);
    color: var(--primary);
  }

  .status-icon.success {
    background: var(--secondary-light);
    color: var(--secondary);
  }

  .status-content h4 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--dark);
  }

  .status-content p {
    font-size: 14px;
    color: var(--dark-light);
    margin: 0;
  }

  /* Placeholder Tags */
  .placeholder-section {
    margin-top: 16px;
  }

  .placeholder-section h5 {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 12px;
    color: var(--dark);
  }

  .placeholder-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .placeholder-tag {
    background: var(--white);
    border: 1px solid var(--gray-300);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-family: 'SF Mono', Monaco, monospace;
    color: var(--primary);
    background-color: var(--primary-light);
  }

  /* Settings Section */
  .settings-section {
    margin-top: 16px;
  }

  .settings-section label {
    display: block;
    font-weight: 500;
    font-size: 14px;
    margin-bottom: 8px;
    color: var(--dark);
  }

  .select-input {
    width: 100%;
    padding: 10px 12px;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--gray-300);
    background: var(--white);
    font-size: 14px;
    color: var(--dark);
    transition: var(--transition);
  }

  .select-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
  }

  /* Progress Steps */
  .progress-card {
    padding: 24px;
    margin-bottom: 24px;
  }

  .progress-tracker {
    position: relative;
    margin: 0 auto;
    max-width: 600px;
  }

  .progress-bar {
    position: absolute;
    top: 18px;
    left: 0;
    height: 4px;
    background: var(--primary);
    z-index: 1;
    transition: var(--transition);
    width: 0%;
  }

  .step-indicators {
    display: flex;
    justify-content: space-between;
    position: relative;
    z-index: 2;
  }

  .step-item {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .step-bubble {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--white);
    border: 2px solid var(--gray-300);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: var(--dark-light);
    margin-bottom: 8px;
    transition: var(--transition);
  }

  .step-item.active .step-bubble {
    border-color: var(--primary);
    background: var(--primary);
    color: var(--white);
  }

  .step-item.completed .step-bubble {
    border-color: var(--secondary);
    background: var(--secondary);
    color: var(--white);
  }

  .step-label {
    font-size: 14px;
    font-weight: 500;
    color: var(--dark-light);
  }

  .step-item.active .step-label {
    color: var(--primary);
    font-weight: 600;
  }

  .step-item.completed .step-label {
    color: var(--secondary);
  }

  /* Document Preview */
  .preview-card {
    min-height: 600px;
    display: flex;
    flex-direction: column;
  }

  .document-preview {
    flex: 1;
    border: 1px solid var(--gray-300);
    border-radius: var(--border-radius);
    background: var(--white);
    overflow-y: auto;
    padding: 32px;
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
    min-height: 400px;
  }

  .preview-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--dark-light);
    text-align: center;
  }

  .preview-placeholder i {
    font-size: 48px;
    margin-bottom: 16px;
    color: var(--gray-400);
  }

  .preview-placeholder h3 {
    font-size: 18px;
    margin-bottom: 8px;
    color: var(--dark);
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 12px;
    padding: 24px;
    border-top: 1px solid var(--gray-200);
  }

  /* Progress Container */
  .progress-container {
    padding: 24px;
    border-top: 1px solid var(--gray-200);
  }

  .progress-header {
    margin-bottom: 16px;
    text-align: center;
  }

  .progress-header h3 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: var(--dark);
  }

  .progress-header p {
    color: var(--dark-light);
    font-size: 14px;
  }

  .progress-track {
    width: 100%;
    height: 8px;
    background: var(--gray-200);
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 12px;
  }

  .progress-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 20px;
    width: 0%;
    transition: width 0.3s ease;
  }

  .progress-details {
    display: flex;
    justify-content: space-between;
    margin-bottom: 16px;
    font-size: 14px;
  }

  #progress-percentage {
    font-weight: 600;
    color: var(--primary);
  }

  #current-file {
    color: var(--dark-light);
  }

  #cancel-btn {
    display: block;
    margin: 0 auto;
  }

  /* Success Message */
  .success-message {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 24px;
    background: var(--secondary-light);
    color: var(--secondary);
    border-radius: var(--border-radius);
    margin: 24px;
    border-left: 4px solid var(--secondary);
  }

  .success-icon {
    font-size: 24px;
  }

  .success-content h4 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .success-content p {
    margin-bottom: 16px;
    font-size: 14px;
  }

  .download-options {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  /* Responsive Adjustments */
  @media (max-width: 1200px) {
    .upload-cards-container {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .app-container {
      padding: 16px;
    }

    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .card-header {
      padding: 16px;
    }

    .card-content {
      padding: 16px;
    }

    .upload-area {
      padding: 24px 16px;
    }

    .step-indicators {
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
    }

    .progress-bar {
      display: none;
    }

    .action-buttons {
      flex-direction: column;
    }

    .btn {
      width: 100%;
    }

    .download-options {
      flex-direction: column;
    }
  }

  @media (max-width: 480px) {
    .app-container {
      padding: 12px;
    }

    .document-preview {
      padding: 16px;
    }

    .success-message {
      margin: 16px;
      flex-direction: column;
      text-align: center;
    }
  }

  /* Utility Classes */
  .hidden {
    display: none !important;
  }

  /* Loading Animation */
  .loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Highlight styles for document preview */
  .template-content {
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
    color: var(--dark);
  }

  .placeholder-highlight {
    background-color: rgba(249, 199, 79, 0.3);
    color: var(--warning);
    padding: 2px 4px;
    border-radius: 3px;
    border: 1px dashed rgba(249, 199, 79, 0.5);
    font-family: 'SF Mono', Monaco, monospace;
  }

  .data-value {
    background-color: rgba(76, 201, 240, 0.2);
    padding: 2px 4px;
    border-radius: 3px;
    border-bottom: 2px solid var(--success);
    font-weight: 500;
  }

  .data-value.highlighted {
    background-color: rgba(14, 159, 110, 0.2);
    border-bottom: 2px solid var(--secondary);
    animation: pulseHighlight 2s ease-in-out;
  }

  @keyframes pulseHighlight {
    0% {
      background-color: rgba(14, 159, 110, 0.1);
    }

    50% {
      background-color: rgba(14, 159, 110, 0.4);
    }

    100% {
      background-color: rgba(14, 159, 110, 0.2);
    }
  }
</style>
{% endblock %}

{% block scripts %}
<!-- JavaScript remains exactly the same as in the original -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
  // Global state
  let progressInterval = null;
  const state = {
    currentTab: 1,
    templateFile: null,
    templatePlaceholders: [],
    templateContent: "",
    templateHTML: "",
    csvData: null,
    csvHeaders: [],
    allRecords: [],
    currentStep: 0,
    dateFormat: "DD MMMM YYYY",
    progressInterval: null,
    cancelRequested: false,
    taskId: null,
  };

  // DOM Elements
  const templateFileInput = document.getElementById("template-file");
  const dataFileInput = document.getElementById("data-file");
  const templateAnalysis = document.getElementById("template-analysis");
  const placeholderCount = document.getElementById("placeholder-count");
  const placeholderItems = document.getElementById("placeholder-items");
  const dataStatus = document.getElementById("data-status");
  const recordCount = document.getElementById("record-count");
  const documentView = document.getElementById("document-view");
  const generateBtn = document.getElementById("generate-btn");
  const resetBtn = document.getElementById("reset-btn");
  const progressBar = document.getElementById("progress-bar");
  const stepIndicators = document.querySelectorAll(".step-item");
  const dateFormatSelect = document.getElementById("date-format");
  const successMessage = document.getElementById("success-message");
  const templateUploadArea = document.getElementById("template-upload-area");
  const dataUploadArea = document.getElementById("data-upload-area");
  const progressContainer = document.getElementById("progress-container");
  const progressBarFill = document.getElementById("progress-bar-fill");
  const progressPercentage = document.getElementById("progress-percentage");
  const currentDocNumber = document.getElementById("current-doc-number");
  const totalDocs = document.getElementById("total-docs");
  const currentFile = document.getElementById("current-file");
  const cancelBtn = document.getElementById("cancel-btn");

  // Initialize application
  function init() {
    setupEventListeners();
    updateProgress();

    // Set up download and email buttons initially (they will be re-set after generation)
    document.getElementById("download-word-btn").onclick = () => {
      alert("Please generate documents first");
    };

    document.getElementById("download-pdf-btn").onclick = () => {
      alert("Please generate documents first");
    };

    document.getElementById("email-btn").onclick = () => {
      alert("Please generate documents first");
    };
  }

  // Set up event listeners
  function setupEventListeners() {
    // Template file upload
    templateFileInput.addEventListener("change", (e) => {
      if (e.target.files.length > 0) {
        state.templateFile = e.target.files[0];
        templateUploadArea.classList.add("active");
        analyzeTemplate(state.templateFile);
      }
    });

    // Data file upload
    dataFileInput.addEventListener("change", (e) => {
      if (e.target.files.length > 0) {
        state.dataFile = e.target.files[0];
        dataUploadArea.classList.add("active");
        processDataFile(state.dataFile);
      }
    });

    // Date format selection
    dateFormatSelect.addEventListener("change", (e) => {
      state.dateFormat = e.target.value;
      if (state.templateHTML && state.csvData) {
        updateDocumentPreview();
      }
    });

    // Generate button
    generateBtn.addEventListener("click", generateDocuments);

    // Reset button
    resetBtn.addEventListener("click", resetApplication);

    // Cancel button
    cancelBtn.addEventListener("click", cancelGeneration);

    // Drag and drop functionality
    setupDragAndDrop();
  }

  // Set up drag and drop
  function setupDragAndDrop() {
    const uploadAreas = document.querySelectorAll(".upload-area");

    uploadAreas.forEach((area) => {
      area.addEventListener("dragover", (e) => {
        e.preventDefault();
        area.style.background = "var(--primary-light)";
        area.style.borderColor = "var(--primary)";
      });

      area.addEventListener("dragleave", (e) => {
        e.preventDefault();
        area.style.background = "";
        area.style.borderColor = "";
      });

      area.addEventListener("drop", (e) => {
        e.preventDefault();
        area.style.background = "";
        area.style.borderColor = "";

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          if (area.id === "template-upload-area") {
            templateFileInput.files = files;
            state.templateFile = files[0];
            area.classList.add("active");
            analyzeTemplate(files[0]);
          } else if (area.id === "data-upload-area") {
            dataFileInput.files = files;
            state.dataFile = files[0];
            area.classList.add("active");
            processDataFile(files[0]);
          }
        }
      });
    });
  }

  // Format date based on selected format
  function formatDate(date, format) {
    const d = new Date(date);
    const day = d.getDate();
    const month = d.getMonth() + 1;
    const year = d.getFullYear();
    const monthNames = [
      "Jan", "Feb", "Mar", "Apr", "May", "Jun",
      "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
    ];
    const monthFullNames = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];

    switch (format) {
      case "DD/MM/YYYY":
        return `${day.toString().padStart(2, "0")}/${month
          .toString()
          .padStart(2, "0")}/${year}`;
      case "MM/DD/YYYY":
        return `${month.toString().padStart(2, "0")}/${day
          .toString()
          .padStart(2, "0")}/${year}`;
      case "DD MMM YYYY":
        return `${day} ${monthNames[month - 1]} ${year}`;
      case "DD MMMM YYYY":
        return `${day} ${monthFullNames[month - 1]} ${year}`;
      default: // YYYY-MM-DD
        return `${year}-${month.toString().padStart(2, "0")}-${day
          .toString()
          .padStart(2, "0")}`;
    }
  }

  // Analyze template function
  function analyzeTemplate(file) {
    const formData = new FormData();
    formData.append("file", file);

    fetch("/document/api/analyze-template", {
      method: "POST",
      body: formData,
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(
            `Server returned ${response.status}: ${response.statusText}`
          );
        }
        return response.json();
      })
      .then((data) => {
        if (data.error) {
          throw new Error(data.error);
        }

        state.templatePlaceholders = data.placeholders;
        state.templateContent = data.content || "";
        placeholderCount.textContent = data.count;

        // Display placeholders
        placeholderItems.innerHTML = "";
        state.templatePlaceholders.forEach((placeholder) => {
          const span = document.createElement("span");
          span.className = "placeholder-tag";
          span.textContent = `{${placeholder}}`;
          placeholderItems.appendChild(span);
        });

        // Create HTML representation of the template
        createTemplateHTML(state.templateContent);

        // Show template content
        documentView.innerHTML = state.templateHTML;

        templateAnalysis.classList.remove("hidden");

        // Update document preview with template content
        updateDocumentPreview();

        // Show next step
        showTab(2);
        updateProgress();
        validateGenerateButton();
      })
      .catch((error) => {
        console.error("Error analyzing template:", error);
        alert("Error analyzing template: " + error.message);
      });
  }


  // Create HTML representation of the template
  function createTemplateHTML(content) {
    if (!content) {
      state.templateHTML = `
        <div class="preview-placeholder">
          <i class="fas fa-file-alt"></i>
          <h3>Template Content Not Available</h3>
        </div>
      `;
      return;
    }

    // Replace placeholders with styled spans
    let htmlContent = content.replace(
      /{([^}]+)}/g,
      '<span class="placeholder-highlight">{$1}</span>'
    );

    // Convert line breaks to paragraphs
    htmlContent = htmlContent
      .split("\n\n")
      .map((paragraph) => {
        if (paragraph.trim() === "") return "";
        return `<p>${paragraph.replace(/\n/g, "<br>")}</p>`;
      })
      .join("");

    state.templateHTML = `<div class="template-content">${htmlContent}</div>`;
  }

  // Process data file
  function processDataFile(file) {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function (results) {
        if (results.errors.length > 0) {
          alert("Error parsing CSV: " + results.errors[0].message);
          return;
        }

        state.csvData = results.data;
        state.csvHeaders = results.meta.fields || [];
        state.allRecords = results.data;

        recordCount.textContent = results.data.length;
        dataStatus.classList.remove("hidden");

        // Update document preview with data
        updateDocumentPreview();

        // Show next step
        showTab(3);
        updateProgress();
        validateGenerateButton();
      },
      error: function (error) {
        console.error("Error parsing CSV:", error);
        alert("Error parsing CSV file: " + error.message);
      },
    });
  }

  // Update document preview
  // Update document preview
  function updateDocumentPreview() {
    if (!state.templateHTML || !state.csvData || state.csvData.length === 0) {
      return;
    }

    // Get the first record for preview
    const record = state.csvData[0];
    let previewHTML = state.templateContent;

    // Add Today to the record for preview
    const today = new Date();
    record.Today = formatDate(today, state.dateFormat);

    // Replace placeholders with data
    for (const [key, value] of Object.entries(record)) {
      // Handle special fields
      let processedValue = value;

      // Check if this is a date field
      if (key.toLowerCase().includes("date") || key === "Today") {
        processedValue = formatDate(value, state.dateFormat);
      }

      // Create regex to match all placeholder variations
      const placeholderRegex = new RegExp(`\\{([*]*)?${key}([*]*)?\\}`, 'gi');

      // Replace with highlighted content
      previewHTML = previewHTML.replace(
        placeholderRegex,
        `<span class="data-value highlighted">${processedValue}</span>`
      );
    }

    // Highlight any remaining placeholders that weren't replaced
    previewHTML = previewHTML.replace(
      /{([^}]+)}/g,
      '<span class="placeholder-highlight">{$1}</span>'
    );

    // Convert to HTML
    previewHTML = previewHTML
      .split("\n\n")
      .map((paragraph) => {
        if (paragraph.trim() === "") return "";
        return `<p>${paragraph.replace(/\n/g, "<br>")}</p>`;
      })
      .join("");

    documentView.innerHTML = `<div class="template-content">${previewHTML}</div>`;
  }

  // Generate documents
  function generateDocuments() {
    if (!state.templateFile || !state.csvData) {
      alert("Please upload both a template and data file first.");
      return;
    }

    // Prepare form data
    const formData = new FormData();
    formData.append("template", state.templateFile);
    formData.append("dateFormat", state.dateFormat);

    // Add CSV data
    const csvBlob = new Blob([Papa.unparse(state.allRecords)], {
      type: "text/csv",
    });
    formData.append("data", csvBlob, "data.csv");

    // Show progress UI
    generateBtn.disabled = true;
    progressContainer.classList.remove("hidden");
    successMessage.classList.add("hidden");
    currentDocNumber.textContent = "0";
    totalDocs.textContent = state.allRecords.length;
    currentFile.textContent = "Starting document generation...";
    state.cancelRequested = false;

    // Start progress animation
    simulateProgress();

    // Send request to server
    fetch("/document/api/generate-documents", {
      method: "POST",
      body: formData,
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(
            `Server returned ${response.status}: ${response.statusText}`
          );
        }
        return response.json();
      })
      .then((data) => {
        if (data.error) {
          throw new Error(data.error);
        }

        // Store the task ID for later use
        state.generationTaskId = data.task_id;

        // Stop progress simulation
        clearInterval(state.progressInterval);

        // Show success message
        progressContainer.classList.add("hidden");
        successMessage.classList.remove("hidden");

        // Set up download buttons - FIXED
        document.getElementById("download-word-btn").onclick = () => {
          if (state.generationTaskId) {
            window.location.href = `/document/api/download/${state.generationTaskId}/word`;
          } else {
            alert("No documents generated yet");
          }
        };

        document.getElementById("download-pdf-btn").onclick = () => {
          if (state.generationTaskId) {
            window.location.href = `/document/api/download/${state.generationTaskId}/pdf`;
          } else {
            alert("No documents generated yet");
          }
        };

        // Set up email button - FIXED
        document.getElementById("email-btn").onclick = () => {
          if (state.generationTaskId) {
            // Get the headers for placeholders
            const headers = state.csvHeaders;
            const headersParam = encodeURIComponent(JSON.stringify(headers));

            // Redirect to email composer with task ID and headers
            window.location.href = `/document/email-composer?taskId=${state.generationTaskId}&headers=${headersParam}`;
          } else {
            alert("No documents generated yet");
          }
        };
        showTab(4);
        updateProgress();
      })
      .catch((error) => {
        console.error("Error generating documents:", error);
        alert("Error generating documents: " + error.message);
        clearInterval(state.progressInterval);
        progressContainer.classList.add("hidden");
        generateBtn.disabled = false;
      });
  }


  // Simulate progress for demo purposes
  function simulateProgress() {
    let progress = 0;
    const total = state.allRecords.length;
    let current = 0;

    state.progressInterval = setInterval(() => {
      if (state.cancelRequested) {
        clearInterval(state.progressInterval);
        progressContainer.classList.add("hidden");
        generateBtn.disabled = false;
        alert("Document generation was cancelled.");
        return;
      }

      if (progress >= 100) {
        clearInterval(state.progressInterval);
        return;
      }

      // Increment progress
      progress += Math.random() * 5;
      if (progress > 100) progress = 100;

      // Update current document
      if (progress < 100) {
        current = Math.floor((progress / 100) * total);
        if (current >= total) current = total - 1;
      } else {
        current = total;
      }

      // Update UI
      progressBarFill.style.width = `${progress}%`;
      progressPercentage.textContent = `${Math.round(progress)}%`;
      currentDocNumber.textContent = current;
      currentFile.textContent = `Processing document ${current} of ${total}`;
    }, 200);
  }

  // Cancel document generation
  function cancelGeneration() {
    state.cancelRequested = true;
  }

  // Reset application
  function resetApplication() {
    if (
      confirm(
        "Are you sure you want to start over? All uploaded files and progress will be lost."
      )
    ) {
      // Reset file inputs
      templateFileInput.value = "";
      dataFileInput.value = "";

      // Reset UI elements
      templateAnalysis.classList.add("hidden");
      dataStatus.classList.add("hidden");
      progressContainer.classList.add("hidden");
      successMessage.classList.add("hidden");
      templateUploadArea.classList.remove("active");
      dataUploadArea.classList.remove("active");
      documentView.innerHTML = `
        <div class="preview-placeholder">
          <i class="fas fa-file-alt"></i>
          <h3>No template uploaded</h3>
          <p>Upload a Word template and CSV data to see a preview</p>
        </div>
      `;
      generateBtn.disabled = true;

      // Reset state
      state.templateFile = null;
      state.templatePlaceholders = [];
      state.templateContent = "";
      state.templateHTML = "";
      state.csvData = null;
      state.csvHeaders = [];
      state.allRecords = [];

      // Reset progress
      state.currentStep = 0;
      showTab(1);
      updateProgress();
    }
  }

  // Show tab
  function showTab(tabNumber) {
    state.currentStep = tabNumber - 1;
    updateProgress();
  }

  // Update progress bar and step indicators
  function updateProgress() {
    // Update progress bar width
    const progressPercentage = (state.currentStep / 3) * 100;
    progressBar.style.width = `${progressPercentage}%`;

    // Update step indicators
    stepIndicators.forEach((step, index) => {
      step.classList.remove("active", "completed");
      if (index < state.currentStep) {
        step.classList.add("completed");
      } else if (index === state.currentStep) {
        step.classList.add("active");
      }
    });
  }

  // Validate if generate button should be enabled
  function validateGenerateButton() {
    generateBtn.disabled = !(
      state.templateFile &&
      state.csvData &&
      state.csvData.length > 0
    );
  }

  // Initialize the application when DOM is loaded
  document.addEventListener("DOMContentLoaded", init);
</script>
{% endblock %}
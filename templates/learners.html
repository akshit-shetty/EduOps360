{% extends "base.html" %}

{% block title %}Learners - EduOps360{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-8">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Learners Management</h1>
            <p class="text-gray-600">Track and manage all your learners in one place</p>
            {% if last_updated %}
            <p class="text-sm text-gray-500 mt-1">
                <i class="fas fa-clock mr-1"></i>Database last updated: {{ last_updated.strftime('%B %d, %Y at %I:%M %p') }}
            </p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Stats Overview -->

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
    <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-2xl font-bold text-gray-800">{{ total_learners|default(0) }}</p>
                <p class="text-sm text-gray-600">Total Learners</p>
            </div>
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-users text-blue-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-2xl font-bold text-green-600">{{ active_learners|default(0) }}</p>
                <p class="text-sm text-gray-600">Active</p>
            </div>
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-user-check text-green-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-2xl font-bold text-red-600">{{ failed_dropout|default(0) }}</p>
                <p class="text-sm text-gray-600">Failed / Drop Out</p>
            </div>
            <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-user-times text-red-600"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-2xl font-bold text-gray-600">{{ inactive_learners|default(0) }}</p>
                <p class="text-sm text-gray-600">Inactive</p>
            </div>
            <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-user-slash text-gray-600"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-2xl font-bold text-purple-600">{{ completed_learners|default(0) }}</p>
                <p class="text-sm text-gray-600">Completed</p>
            </div>
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-graduation-cap text-purple-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="bg-white rounded-xl shadow-md p-6 mb-6 border border-gray-100">
    <div class="mb-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Search & Filter Learners</h3>
    </div>
    
    <form method="GET" action="{{ url_for('learners') }}" id="filtersForm">
        <div class="flex flex-col lg:flex-row gap-6">
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <div class="relative">
                    <input type="text" 
                           name="search"
                           value="{{ request.args.get('search', '') }}"
                           placeholder="Search learners by name, email, or ID..." 
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           onkeyup="debounceSearch(this.value)">
                    <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                    {% if request.args.get('search') %}
                    <div class="absolute right-3 top-3.5">
                        <button type="button" onclick="clearSearch()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="flex flex-wrap gap-4 items-end">
                <!-- Cohorts Dropdown -->
                <div class="min-w-[200px] relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-users mr-1 text-green-600"></i>
                        Cohorts
                        <span class="text-xs text-gray-500 ml-1">({{ selected_cohorts|length }} selected)</span>
                    </label>
                    <div class="relative">
                        <button type="button" onclick="toggleDropdown('cohort')" class="w-full px-3 py-2 text-left border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white flex items-center justify-between">
                            <span class="text-gray-700">
                                {% if selected_cohorts %}
                                    {{ selected_cohorts|length }} cohort{{ 's' if selected_cohorts|length > 1 else '' }} selected
                                {% else %}
                                    Select cohorts...
                                {% endif %}
                            </span>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </button>
                        <div id="cohort-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-48 overflow-y-auto">
                            {% for cohort in cohorts %}
                            <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" name="cohort" value="{{ cohort }}" 
                                       {% if cohort|string in selected_cohorts|map('string')|list %}checked{% endif %}
                                       onchange="updateDropdownSelection('cohort')" 
                                       class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm">Cohort {{ cohort }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Status Dropdown -->
                <div class="min-w-[200px] relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-info-circle mr-1 text-purple-600"></i>
                        Status
                        <span class="text-xs text-gray-500 ml-1">({{ selected_statuses|length }} selected)</span>
                    </label>
                    <div class="relative">
                        <button type="button" onclick="toggleDropdown('status')" class="w-full px-3 py-2 text-left border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white flex items-center justify-between">
                            <span class="text-gray-700">
                                {% if selected_statuses %}
                                    {{ selected_statuses|length }} status{{ 'es' if selected_statuses|length > 1 else '' }} selected
                                {% else %}
                                    Select status...
                                {% endif %}
                            </span>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </button>
                        <div id="status-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-48 overflow-y-auto">
                            {% for status in statuses %}
                            <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" name="status" value="{{ status }}" 
                                       {% if status in selected_statuses %}checked{% endif %}
                                       onchange="updateDropdownSelection('status')" 
                                       class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm">{{ status }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Slots Dropdown -->
                <div class="min-w-[200px] relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-clock mr-1 text-orange-600"></i>
                        Slots
                        <span class="text-xs text-gray-500 ml-1">({{ selected_slots|length }} selected)</span>
                    </label>
                    <div class="relative">
                        <button type="button" onclick="toggleDropdown('slot')" class="w-full px-3 py-2 text-left border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white flex items-center justify-between">
                            <span class="text-gray-700">
                                {% if selected_slots %}
                                    {{ selected_slots|length }} slot{{ 's' if selected_slots|length > 1 else '' }} selected
                                {% else %}
                                    Select slots...
                                {% endif %}
                            </span>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </button>
                        <div id="slot-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-48 overflow-y-auto">
                            {% for slot in slots %}
                            <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" name="slot" value="{{ slot }}" 
                                       {% if slot in selected_slots %}checked{% endif %}
                                       onchange="updateDropdownSelection('slot')" 
                                       class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm">{{ slot }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Clear All Button -->
                <button type="button" onclick="clearFilters()" class="px-3 py-2 bg-red-50 text-red-700 border border-red-200 rounded-md hover:bg-red-100 hover:border-red-300 transition-colors text-sm whitespace-nowrap">
                    <i class="fas fa-times mr-1"></i>Clear All
                </button>
            </div>
        </div>
    </form>
    
    <!-- Active Filters Display -->
    {% if request.args.get('search') or selected_cohorts or selected_statuses or selected_slots %}
    <div class="mb-6" id="active-filters-container">
        <div class="bg-gray-50 rounded-lg p-4" id="active-filters-content">
            <div class="flex flex-wrap gap-3 items-center">
                <span class="text-sm text-gray-700 font-semibold">Active Filters:</span>
                
                {% if request.args.get('search') %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-search mr-2 text-xs"></i>
                    Search: "{{ request.args.get('search') }}"
                    <button type="button" onclick="clearSpecificFilter('search', '')" class="ml-2 text-blue-600 hover:text-blue-900 transition-colors">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
                {% endif %}
                
                {% for cohort in selected_cohorts %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-users mr-2 text-xs"></i>
                    Cohort {{ cohort }}
                    <button type="button" onclick="clearSpecificFilter('cohort', '{{ cohort }}')" class="ml-2 text-green-600 hover:text-green-900 transition-colors">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
                {% endfor %}
                
                {% for status in selected_statuses %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-info-circle mr-2 text-xs"></i>
                    {{ status }}
                    <button type="button" onclick="clearSpecificFilter('status', '{{ status }}')" class="ml-2 text-purple-600 hover:text-purple-900 transition-colors">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
                {% endfor %}
                
                {% for slot in selected_slots %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-clock mr-2 text-xs"></i>
                    {{ slot }}
                    <button type="button" onclick="clearSpecificFilter('slot', '{{ slot }}')" class="ml-2 text-orange-600 hover:text-orange-900 transition-colors">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
                {% endfor %}
                
                <button type="button" onclick="clearFilters()" class="inline-flex items-center px-3 py-1 text-xs text-gray-600 hover:text-gray-800 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                    <i class="fas fa-times mr-1"></i>
                    Clear All
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Learners Table -->
<div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Full name</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Slot</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Progress</th>
                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Courses Completed</th>
                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for learner in learners %}
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-indigo-600 rounded-full flex items-center justify-center text-white font-semibold">
                                {{ learner['First Name'][0]|upper }}{{ learner['Last Name'][0]|upper }}
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-semibold text-gray-800">{{ learner['First Name'] }} {{ learner['Last Name'] }}</p>
                                <p class="text-xs text-gray-500">Cohort: {{ learner['Cohort #'] }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <p class="text-sm text-gray-700">{{ learner.Email }}</p>
                        <p class="text-xs text-gray-500">{{ learner.Batch }}</p>
                    </td>
                    <td class="px-6 py-4">
                        <p class="text-sm font-medium text-gray-800">{{ learner.Batch }}</p>
                        <p class="text-xs text-gray-500">{{ learner.Slot[:6] }}</p>
                    </td>
                    <td class="px-6 py-4">
                        {% set net_completed = (learner['Courses Completed']|default(0)) - (learner['Courses Incomplete']|default(0)) %}
                        {% set progress = ((net_completed / 7) * 100)|round|int %}
                        <div class="flex items-center">
                            <div class="flex-1 bg-gray-200 rounded-full h-2 mr-3">
                                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-2 rounded-full" style="width: {{ progress }}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-700">{{ progress }}%</span>
                        </div>
                    </td>
                    <td class="px-8 py-6 text-center">
                        <span class="inline-block px-4 py-2 text-sm font-medium 
                               {% if learner.Status == 'Active' %}bg-green-100 text-green-700
                               {% elif learner.Status == 'Completed' %}bg-purple-100 text-purple-700
                               {% elif learner.Status == 'In Progress' %}bg-yellow-100 text-yellow-700
                               {% else %}bg-gray-100 text-gray-700{% endif %} rounded-full min-w-[100px] max-w-[100px] truncate whitespace-nowrap" 
                               title="{{ learner.Status }}">
                            {% if learner.Status|length > 8 %}
                                {{ learner.Status[:8] }}...
                            {% else %}
                                {{ learner.Status }}
                            {% endif %}
                        </span>
                    </td>
                    <td class="px-8 py-6 text-center">
                        <div class="flex flex-col items-center justify-center">
                            {% set net_completed = (learner['Courses Completed']|default(0)) - (learner['Courses Incomplete']|default(0)) %}
                            <p class="text-lg font-bold text-gray-800 mb-1">{{ net_completed }}/7</p>
                            <p class="text-xs text-gray-500">
                                {% if (7 - net_completed) > 0 %}
                                    {{ 7 - net_completed }} remaining
                                {% else %}
                                    Complete
                                {% endif %}
                            </p>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center justify-center">
                            <a href="{{ url_for('learner_profile', user_id=learner.get('User ID', learner.Email)) }}" 
                               class="p-3 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors inline-block" 
                               title="View Profile in New Tab"
                               target="_blank">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center">
                        <div class="text-gray-500">
                            <i class="fas fa-users text-4xl mb-4"></i>
                            <p class="text-lg font-medium">No learners found</p>
                            <p class="text-sm">Try adjusting your search or filter criteria</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
        <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-600">Show</span>
            <select id="entriesPerPage" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="changeEntriesPerPage()">
                <option value="10" {{ 'selected' if pagination.per_page == 10 else '' }}>10</option>
                <option value="25" {{ 'selected' if pagination.per_page == 25 else '' }}>25</option>
                <option value="50" {{ 'selected' if pagination.per_page == 50 else '' }}>50</option>
                <option value="100" {{ 'selected' if pagination.per_page == 100 else '' }}>100</option>
            </select>
            <span class="text-sm text-gray-600">entries</span>
        </div>
        <div class="flex items-center space-x-2">
            <p class="text-sm text-gray-600">
                Showing <span class="font-medium">{{ ((pagination.page - 1) * pagination.per_page) + 1 }}</span> 
                to <span class="font-medium">{{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }}</span> 
                of <span class="font-medium">{{ pagination.total }}</span> learners
            </p>
        </div>
        <div class="flex space-x-2">
            {% if pagination.has_prev %}
            <a href="javascript:void(0)" onclick="navigateToPage({{ pagination.prev_num }})" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                <i class="fas fa-chevron-left"></i>
            </a>
            {% else %}
            <button class="px-3 py-1 border border-gray-300 rounded-lg opacity-50 cursor-not-allowed" disabled>
                <i class="fas fa-chevron-left"></i>
            </button>
            {% endif %}
            
            {% for page_num in range(1, pagination.pages + 1) %}
                {% if page_num == pagination.page %}
                <button class="px-3 py-1 bg-blue-600 text-white rounded-lg">{{ page_num }}</button>
                {% elif page_num <= 3 or page_num > pagination.pages - 3 or (page_num >= pagination.page - 1 and page_num <= pagination.page + 1) %}
                <a href="javascript:void(0)" onclick="navigateToPage({{ page_num }})" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">{{ page_num }}</a>
                {% elif page_num == 4 or page_num == pagination.pages - 3 %}
                <span class="px-3 py-1">...</span>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
            <a href="javascript:void(0)" onclick="navigateToPage({{ pagination.next_num }})" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                <i class="fas fa-chevron-right"></i>
            </a>
            {% else %}
            <button class="px-3 py-1 border border-gray-300 rounded-lg opacity-50 cursor-not-allowed" disabled>
                <i class="fas fa-chevron-right"></i>
            </button>
            {% endif %}
        </div>
    </div>
</div>

<script>
let searchTimeout;

// Global function to update dropdown button text
function updateDropdownButtonText(filterType) {
    const checkboxes = document.querySelectorAll(`input[name="${filterType}"]:checked`);
    const button = document.querySelector(`[onclick="toggleDropdown('${filterType}')"] span`);
    const count = checkboxes.length;
    
    if (button && count > 0) {
        let text = '';
        if (filterType === 'cohort') {
            text = `${count} cohort${count > 1 ? 's' : ''} selected`;
        } else if (filterType === 'status') {
            text = `${count} status${count > 1 ? 'es' : ''} selected`;
        } else if (filterType === 'slot') {
            text = `${count} slot${count > 1 ? 's' : ''} selected`;
        }
        button.textContent = text;
    } else if (button) {
        if (filterType === 'cohort') {
            button.textContent = 'Select cohorts...';
        } else if (filterType === 'status') {
            button.textContent = 'Select status...';
        } else if (filterType === 'slot') {
            button.textContent = 'Select slots...';
        }
    }
}

// Global function to update all dropdown button texts
function updateAllDropdownButtonText() {
    updateDropdownButtonText('cohort');
    updateDropdownButtonText('status');
    updateDropdownButtonText('slot');
}

function debounceSearch(searchValue) {
    // Update active filters immediately for visual feedback
    updateActiveFiltersImmediate();
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        if (searchValue.length >= 2 || searchValue.length === 0) {
            submitFilters();
        }
    }, 500); // Wait 500ms after user stops typing
}

function submitFilters(keepDropdownOpen = false) {
    const form = document.getElementById('filtersForm');
    const params = new URLSearchParams();
    
    // Add search parameter
    const searchInput = form.querySelector('input[name="search"]');
    if (searchInput && searchInput.value.trim()) {
        params.append('search', searchInput.value.trim());
    }
    
    // Add checked checkboxes
    const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
        params.append(checkbox.name, checkbox.value);
    });
    
    // Preserve current per_page setting
    const perPageSelect = document.getElementById('entriesPerPage');
    if (perPageSelect) {
        params.set('per_page', perPageSelect.value);
    }
    
    // Reset to page 1 when filters change
    params.set('page', '1');
    
    if (keepDropdownOpen) {
        // Use AJAX to update content without page reload
        fetchFilteredResults(params);
    } else {
        // Navigate to filtered results (for search and clear operations)
        const url = `${window.location.pathname}?${params.toString()}`;
        window.location.href = url;
    }
}

function fetchFilteredResults(params) {
    // Show loading indicator
    const tableContainer = document.querySelector('.overflow-x-auto');
    const originalContent = tableContainer.innerHTML;
    
    // Add loading spinner
    tableContainer.innerHTML = `
        <div class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-3 text-gray-600">Loading...</span>
        </div>
    `;
    
    // Fetch filtered results
    const url = `${window.location.pathname}?${params.toString()}`;
    
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Parse the response and extract the table content
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newTableContainer = doc.querySelector('.overflow-x-auto');
        
        if (newTableContainer) {
            tableContainer.innerHTML = newTableContainer.innerHTML;
        }
        
        // Update filter dropdowns with smart options
        updateFilterDropdowns(doc);
        
        // Update active filters section
        updateActiveFiltersSection(doc);
        
        // Update URL without page reload
        window.history.pushState({}, '', url);
        
        // Update dropdown button text
        updateAllDropdownButtonText();
        
        // Re-attach event listeners
        attachEventListeners();
    })
    .catch(error => {
        console.error('Error fetching filtered results:', error);
        // Restore original content on error
        tableContainer.innerHTML = originalContent;
    });
}

function clearSearch() {
    // Clear only search input
    const form = document.getElementById('filtersForm');
    form.querySelector('input[name="search"]').value = '';
    submitFilters();
}

function toggleDropdown(filterType) {
    const dropdown = document.getElementById(`${filterType}-dropdown`);
    const allDropdowns = document.querySelectorAll('[id$="-dropdown"]');
    
    // Close all other dropdowns
    allDropdowns.forEach(dd => {
        if (dd !== dropdown) {
            dd.classList.add('hidden');
        }
    });
    
    // Toggle current dropdown
    if (dropdown) {
        dropdown.classList.toggle('hidden');
    }
}

let filterTimeout;

function updateDropdownSelection(filterType) {
    // Update button text immediately
    updateDropdownButtonText(filterType);
    
    // Debounce filter submission to prevent too many rapid calls
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
        submitFilters(true); // Keep dropdown open
    }, 300); // Wait 300ms after last change
}

// Function to attach event listeners to checkboxes
function attachEventListeners() {
    // Add event listeners to all checkboxes for real-time button updates
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.removeEventListener('change', handleCheckboxChange); // Remove existing listener
        checkbox.addEventListener('change', handleCheckboxChange);
    });
}

// Checkbox change handler
function handleCheckboxChange(event) {
    const filterType = event.target.name;
    updateDropdownButtonText(filterType);
    
    // Update active filters immediately for visual feedback
    updateActiveFiltersImmediate();
}

function clearSpecificFilter(filterType, filterValue) {
    const form = document.getElementById('filtersForm');
    
    if (filterType === 'search') {
        // Clear search input
        form.querySelector('input[name="search"]').value = '';
    } else {
        // Clear specific filter value from checkboxes
        const checkboxes = form.querySelectorAll(`input[name="${filterType}"]`);
        checkboxes.forEach(checkbox => {
            if (checkbox.value === filterValue) {
                checkbox.checked = false;
            }
        });
    }
    
    // Update active filters immediately
    updateActiveFiltersImmediate();
    
    submitFilters();
}

function clearFilters() {
    // Clear all form inputs
    const form = document.getElementById('filtersForm');
    form.querySelector('input[name="search"]').value = '';
    
    // Clear all checkboxes
    const checkboxes = form.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Update active filters immediately
    updateActiveFiltersImmediate();
    
    // Preserve per_page setting when clearing filters
    const perPageSelect = document.getElementById('entriesPerPage');
    const params = new URLSearchParams();
    if (perPageSelect) {
        params.set('per_page', perPageSelect.value);
    }
    
    // Redirect with only per_page parameter preserved
    const url = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
    window.location.href = url;
}

// Initialize page functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize dropdown button texts
    updateAllDropdownButtonText();
    
    // Attach event listeners to checkboxes
    attachEventListeners();
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        const dropdowns = document.querySelectorAll('[id$="-dropdown"]');
        const dropdownButtons = document.querySelectorAll('[onclick*="toggleDropdown"]');
        
        let clickedOnDropdown = false;
        
        // Check if clicked on dropdown or its button
        dropdownButtons.forEach(button => {
            if (button.contains(e.target)) {
                clickedOnDropdown = true;
            }
        });
        
        dropdowns.forEach(dropdown => {
            if (dropdown.contains(e.target)) {
                clickedOnDropdown = true;
            }
        });
        
        // If clicked outside, close all dropdowns
        if (!clickedOnDropdown) {
            dropdowns.forEach(dropdown => {
                dropdown.classList.add('hidden');
            });
        }
    });
});

// Function to handle entries per page change
function changeEntriesPerPage() {
    const select = document.getElementById('entriesPerPage');
    const perPage = select.value;
    
    // Get current filters from form to preserve them
    const form = document.getElementById('filtersForm');
    const params = new URLSearchParams();
    
    // Add search parameter
    const searchInput = form.querySelector('input[name="search"]');
    if (searchInput && searchInput.value.trim()) {
        params.append('search', searchInput.value.trim());
    }
    
    // Add checked checkboxes (filters)
    const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
        params.append(checkbox.name, checkbox.value);
    });
    
    // Update per_page parameter
    params.set('per_page', perPage);
    
    // Reset to page 1 when changing entries per page
    params.set('page', '1');
    
    // Redirect to updated URL with all filters preserved
    window.location.href = window.location.pathname + '?' + params.toString();
}

// Function to navigate to a specific page while preserving filters
function navigateToPage(pageNum) {
    const form = document.getElementById('filtersForm');
    const params = new URLSearchParams();
    
    // Add search parameter
    const searchInput = form.querySelector('input[name="search"]');
    if (searchInput && searchInput.value.trim()) {
        params.append('search', searchInput.value.trim());
    }
    
    // Add checked checkboxes (filters)
    const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
        params.append(checkbox.name, checkbox.value);
    });
    
    // Add current per_page setting
    const perPageSelect = document.getElementById('entriesPerPage');
    if (perPageSelect) {
        params.set('per_page', perPageSelect.value);
    }
    
    // Set the target page
    params.set('page', pageNum);
    
    // Navigate to the new URL
    window.location.href = window.location.pathname + '?' + params.toString();
}

// Function to update filter dropdowns with cascading smart options
function updateFilterDropdowns(doc) {
    console.log('🔍 Updating cascading filter dropdowns...');
    
    // Get current selections to preserve them
    const currentCohorts = Array.from(document.querySelectorAll('input[name="cohort"]:checked')).map(cb => cb.value);
    const currentSlots = Array.from(document.querySelectorAll('input[name="slot"]:checked')).map(cb => cb.value);
    const currentStatuses = Array.from(document.querySelectorAll('input[name="status"]:checked')).map(cb => cb.value);
    
    console.log('🔍 Current selections:', { cohorts: currentCohorts, slots: currentSlots, statuses: currentStatuses });
    
    // Update cohort dropdown with cascading options
    const newCohortDropdown = doc.querySelector('#cohort-dropdown');
    const currentCohortDropdown = document.querySelector('#cohort-dropdown');
    if (newCohortDropdown && currentCohortDropdown) {
        currentCohortDropdown.innerHTML = newCohortDropdown.innerHTML;
        // Restore valid selections (only if they still exist in new options)
        currentCohorts.forEach(cohort => {
            const checkbox = currentCohortDropdown.querySelector(`input[value="${cohort}"]`);
            if (checkbox) {
                checkbox.checked = true;
                console.log(`🔍 Restored cohort selection: ${cohort}`);
            } else {
                console.log(`🔍 Cohort ${cohort} no longer available, removing from selection`);
            }
        });
    }
    
    // Update status dropdown with cascading options
    const newStatusDropdown = doc.querySelector('#status-dropdown');
    const currentStatusDropdown = document.querySelector('#status-dropdown');
    if (newStatusDropdown && currentStatusDropdown) {
        currentStatusDropdown.innerHTML = newStatusDropdown.innerHTML;
        // Restore valid selections
        currentStatuses.forEach(status => {
            const checkbox = currentStatusDropdown.querySelector(`input[value="${status}"]`);
            if (checkbox) {
                checkbox.checked = true;
                console.log(`🔍 Restored status selection: ${status}`);
            } else {
                console.log(`🔍 Status ${status} no longer available, removing from selection`);
            }
        });
    }
    
    // Update slot dropdown with cascading options
    const newSlotDropdown = doc.querySelector('#slot-dropdown');
    const currentSlotDropdown = document.querySelector('#slot-dropdown');
    if (newSlotDropdown && currentSlotDropdown) {
        currentSlotDropdown.innerHTML = newSlotDropdown.innerHTML;
        // Restore valid selections
        currentSlots.forEach(slot => {
            const checkbox = currentSlotDropdown.querySelector(`input[value="${slot}"]`);
            if (checkbox) {
                checkbox.checked = true;
                console.log(`🔍 Restored slot selection: ${slot}`);
            } else {
                console.log(`🔍 Slot ${slot} no longer available, removing from selection`);
            }
        });
    }
    
    // Re-attach event listeners to updated checkboxes
    attachEventListeners();
    
    // Update button texts to reflect current state
    updateAllDropdownButtonText();
    
    console.log('🔍 Cascading filter dropdowns updated successfully');
}

// Function to update active filters section
function updateActiveFiltersSection(doc) {
    console.log('🔍 Updating active filters section...');
    
    const newActiveFiltersContainer = doc.querySelector('#active-filters-container');
    const currentActiveFiltersContainer = document.querySelector('#active-filters-container');
    
    if (newActiveFiltersContainer && currentActiveFiltersContainer) {
        // Replace the entire active filters container
        currentActiveFiltersContainer.outerHTML = newActiveFiltersContainer.outerHTML;
        console.log('🔍 Active filters section updated with new content');
    } else if (!newActiveFiltersContainer && currentActiveFiltersContainer) {
        // Remove active filters section if no filters are active
        currentActiveFiltersContainer.remove();
        console.log('🔍 Active filters section removed (no active filters)');
    } else if (newActiveFiltersContainer && !currentActiveFiltersContainer) {
        // Add active filters section if it doesn't exist but should
        const filtersForm = document.getElementById('filtersForm');
        if (filtersForm && filtersForm.parentNode) {
            filtersForm.insertAdjacentHTML('afterend', newActiveFiltersContainer.outerHTML);
            console.log('🔍 Active filters section added');
        }
    }
}

// Function to generate active filters HTML dynamically
function generateActiveFiltersHTML() {
    const form = document.getElementById('filtersForm');
    const searchInput = form.querySelector('input[name="search"]');
    const selectedCohorts = Array.from(form.querySelectorAll('input[name="cohort"]:checked')).map(cb => cb.value);
    const selectedStatuses = Array.from(form.querySelectorAll('input[name="status"]:checked')).map(cb => cb.value);
    const selectedSlots = Array.from(form.querySelectorAll('input[name="slot"]:checked')).map(cb => cb.value);
    const searchValue = searchInput ? searchInput.value.trim() : '';
    
    const hasActiveFilters = searchValue || selectedCohorts.length > 0 || selectedStatuses.length > 0 || selectedSlots.length > 0;
    
    if (!hasActiveFilters) {
        return '';
    }
    
    let filtersHTML = `
        <div class="mb-6" id="active-filters-container">
            <div class="bg-gray-50 rounded-lg p-4" id="active-filters-content">
                <div class="flex flex-wrap gap-3 items-center">
                    <span class="text-sm text-gray-700 font-semibold">Active Filters:</span>
    `;
    
    // Add search filter
    if (searchValue) {
        filtersHTML += `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200">
                <i class="fas fa-search mr-2 text-xs"></i>
                Search: "${searchValue}"
                <button type="button" onclick="clearSpecificFilter('search', '')" class="ml-2 text-blue-600 hover:text-blue-900 transition-colors">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `;
    }
    
    // Add cohort filters
    selectedCohorts.forEach(cohort => {
        filtersHTML += `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 border border-green-200">
                <i class="fas fa-users mr-2 text-xs"></i>
                Cohort ${cohort}
                <button type="button" onclick="clearSpecificFilter('cohort', '${cohort}')" class="ml-2 text-green-600 hover:text-green-900 transition-colors">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `;
    });
    
    // Add status filters
    selectedStatuses.forEach(status => {
        filtersHTML += `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800 border border-purple-200">
                <i class="fas fa-info-circle mr-2 text-xs"></i>
                ${status}
                <button type="button" onclick="clearSpecificFilter('status', '${status}')" class="ml-2 text-purple-600 hover:text-purple-900 transition-colors">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `;
    });
    
    // Add slot filters
    selectedSlots.forEach(slot => {
        filtersHTML += `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800 border border-orange-200">
                <i class="fas fa-clock mr-2 text-xs"></i>
                ${slot}
                <button type="button" onclick="clearSpecificFilter('slot', '${slot}')" class="ml-2 text-orange-600 hover:text-orange-900 transition-colors">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `;
    });
    
    // Add clear all button
    filtersHTML += `
                    <button type="button" onclick="clearFilters()" class="inline-flex items-center px-3 py-1 text-xs text-gray-600 hover:text-gray-800 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                        <i class="fas fa-times mr-1"></i>
                        Clear All
                    </button>
                </div>
            </div>
        </div>
    `;
    
    return filtersHTML;
}

// Function to update active filters immediately (without AJAX)
function updateActiveFiltersImmediate() {
    const currentContainer = document.querySelector('#active-filters-container');
    const newHTML = generateActiveFiltersHTML();
    
    if (currentContainer && !newHTML) {
        // Remove if no active filters
        currentContainer.remove();
    } else if (currentContainer && newHTML) {
        // Update existing
        currentContainer.outerHTML = newHTML;
    } else if (!currentContainer && newHTML) {
        // Add new
        const filtersForm = document.getElementById('filtersForm');
        if (filtersForm) {
            filtersForm.insertAdjacentHTML('afterend', newHTML);
        }
    }
}
</script>
{% endblock %}

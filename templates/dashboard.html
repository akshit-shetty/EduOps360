{% extends "base.html" %}

{% block title %}Dashboard - EduOps360{% endblock %}

{% block content %}
<div class="min-h-screen">
    <!-- Dashboard Header -->
    <div class="mb-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">
                    Welcome to Your Dashboard,
                    <span class="bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                        {{ session.get('first_name', 'User') }} {{ session.get('last_name', '') }}
                    </span>
                    {% if session.get('role') == 'admin' %}
                    <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gradient-to-r from-purple-100 to-pink-100 text-purple-800 ml-2">
                        <i class="fas fa-crown mr-1"></i>Admin
                    </span>
                    {% endif %}
                </h1>
                <p class="text-gray-600">Monitor your educational operations at a glance</p>
                {% if last_updated %}
                <p class="text-sm text-gray-500 mt-1">
                    <i class="fas fa-clock mr-1"></i>Database last updated: {{ last_updated.strftime('%B %d, %Y at %I:%M
                    %p') }}
                </p>
                {% endif %}
            </div>

            <!-- Admin Upload Section -->
            {% if session.get('role') == 'admin' %}
            <div class="bg-white rounded-2xl shadow-lg p-4 border border-gray-100 min-w-80">
                <div class="flex items-center gap-3 mb-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-orange-400 to-red-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-database text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-800">Database Management</h3>
                        <p class="text-xs text-gray-500">Admin Only - Update Database</p>
                    </div>
                </div>
                <button onclick="openUploadModal()"
                    class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white text-xs font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2 hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-upload"></i>
                    Upload Database
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Program Overview - Two Phase Design -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <!-- Coursework Phase Card -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow-lg border border-blue-100 p-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div
                        class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-book-open text-white text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Coursework Phase</h2>
                        <p class="text-sm text-gray-600">14 Months • 7 Courses • CGPA ≥3.0</p>
                    </div>
                </div>
                <a href="{{ url_for('coursework') }}"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200">
                    View Details
                </a>
            </div>

            <!-- Coursework Stats Grid -->
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div class="bg-white rounded-xl p-3 border border-blue-100">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-user-graduate text-blue-500"></i>
                        <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">
                            Learners
                        </span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">{{ coursework_stats.total_learners|default(0) }}</h3>
                    <p class="text-xs text-gray-600">Total Learners</p>
                </div>

                <div class="bg-white rounded-xl p-3 border border-green-100">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span class="text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded">
                            Progress
                        </span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">{{ coursework_stats.avg_completion_rate|default(0) }}%
                    </h3>
                    <p class="text-xs text-gray-600">Completion Rate</p>
                </div>

                <div class="bg-white rounded-xl p-3 border border-purple-100">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-users text-purple-500"></i>
                        <span class="text-xs font-medium text-purple-600 bg-purple-50 px-2 py-1 rounded">
                            Attendance
                        </span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">{{ coursework_stats.avg_attendance_rate|default(0) }}%
                    </h3>
                    <p class="text-xs text-gray-600">Live Sessions</p>
                </div>

                <div class="bg-white rounded-xl p-3 border border-orange-100">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-star text-orange-500"></i>
                        <span class="text-xs font-medium text-orange-600 bg-orange-50 px-2 py-1 rounded">
                            Rating
                        </span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">{{ coursework_stats.avg_course_rating|default(0) }}/5
                    </h3>
                    <p class="text-xs text-gray-600">Avg Rating</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex space-x-2">
                <a href="{{ url_for('coursework') }}"
                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors duration-200">
                    <i class="fas fa-book mr-1"></i> Coursework
                </a>
                <button
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors duration-200">
                    <i class="fas fa-chart-bar mr-1"></i> Analytics
                </button>
            </div>
        </div>

        <!-- Dissertation Phase Card -->
        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl shadow-lg border border-purple-100 p-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div
                        class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-white text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Dissertation Phase</h2>
                        <p class="text-sm text-gray-600">22 Months • Research & Thesis</p>
                    </div>
                </div>
                <a href="{{ url_for('dissertation') }}"
                    class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200">
                    View Details
                </a>
            </div>

            <!-- Dissertation Stats Grid -->
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div class="bg-white rounded-xl p-3 border border-purple-100">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-users text-purple-500"></i>
                        <span class="text-xs font-medium text-purple-600 bg-purple-50 px-2 py-1 rounded">
                            Students
                        </span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">{{ dissertation_analytics.total_dissertation|default(0)
                        }}</h3>
                    <p class="text-xs text-gray-600">In Dissertation</p>
                </div>
                <div class="bg-white rounded-xl p-3 border border-green-100">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-thumbs-up text-green-500"></i>
                        <span class="text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded">
                            Approved
                        </span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">{{ dissertation_analytics.total_approvals|default(0) }}
                    </h3>
                    <p class="text-xs text-gray-600">Total Approved</p>
                </div>

                <div class="bg-white rounded-xl p-3 border border-orange-100">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-clock text-orange-500"></i>
                        <span class="text-xs font-medium text-orange-600 bg-orange-50 px-2 py-1 rounded">
                            Pending
                        </span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">{{
                        dissertation_analytics.overall_pending_review|default(0) }}</h3>
                    <p class="text-xs text-gray-600">Pending Review</p>
                </div>
                <div class="bg-white rounded-xl p-4 border border-red-100">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-times-circle text-red-500"></i>
                        <span class="text-xs font-medium text-red-600 bg-red-50 px-2 py-1 rounded">
                            Not Approved
                        </span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">{{ dissertation_analytics.total_not_approved|default(0)
                        }}</h3>
                    <p class="text-xs text-gray-600">Total Not Approved</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex space-x-2">
                <a href="{{ url_for('dissertation') }}"
                    class="flex-1 bg-purple-500 hover:bg-purple-600 text-white text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors duration-200">
                    <i class="fas fa-chart-pie mr-1"></i> Progress
                </a>
                <a href="{{ url_for('learners') }}"
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors duration-200">
                    <i class="fas fa-list mr-1"></i> Learners
                </a>
            </div>
        </div>
    </div>

    <!-- Overall Program Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
        <!-- Total Learners Card -->
        <div
            class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between mb-4">
                <div
                    class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-users text-white text-xl"></i>
                </div>
                <span class="text-sm font-medium text-green-600 bg-green-50 px-2 py-1 rounded-lg">
                    <i class="fas fa-arrow-up text-xs mr-1"></i>Total
                </span>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">{{ total_learners|default(0) }}</h3>
            <p class="text-sm text-gray-600 mt-1">Total Learners</p>
        </div>

        <!-- Active Learners Card -->
        <div
            class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between mb-4">
                <div
                    class="w-12 h-12 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-user-check text-white text-xl"></i>
                </div>
                <span class="text-sm font-medium text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg">
                    <i class="fas fa-check text-xs mr-1"></i>Active
                </span>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">{{ active_learners_count|default(0) }}</h3>
            <p class="text-sm text-gray-600 mt-1">Active Learners</p>
        </div>

        <!-- Need Attention Learners Card -->
        <div
            class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between mb-4">
                <div
                    class="w-12 h-12 bg-gradient-to-br from-red-400 to-red-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                </div>
                <span class="text-sm font-medium text-red-600 bg-red-50 px-2 py-1 rounded-lg">
                    <i class="fas fa-warning text-xs mr-1"></i>Alert
                </span>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">{{ low_credit_count|default(14) }}</h3>
            <p class="text-sm text-gray-600 mt-1">Need Attention</p>
        </div>

        <!-- Average CGPA Card -->
        <div
            class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between mb-4">
                <div
                    class="w-12 h-12 bg-gradient-to-br from-orange-400 to-orange-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-chart-line text-white text-xl"></i>
                </div>
                <span
                    class="text-sm font-medium text-{% if avg_cgpa >= 3.5 %}green{% elif avg_cgpa >= 3.0 %}yellow{% else %}red{% endif %}-600 bg-{% if avg_cgpa >= 3.5 %}green{% elif avg_cgpa >= 3.0 %}yellow{% else %}red{% endif %}-50 px-2 py-1 rounded-lg">
                    <i class="fas fa-star text-xs mr-1"></i>CGPA
                </span>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">{{ "%.2f"|format(avg_cgpa|default(3.36)) }}</h3>
            <p class="text-sm text-gray-600 mt-1">Average CGPA</p>
        </div>
    </div>

    <!-- Recent Activities -->
    <div class="grid grid-cols-1 gap-4 md:gap-6">
        <!-- Learners Needing Attention -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <!-- Header Section -->
            <div class="bg-gradient-to-r from-red-50 to-orange-50 px-6 py-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-red-500 to-orange-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-white text-lg"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Learners Needing Attention</h2>
                            <p class="text-sm text-gray-600">Students with low grades requiring support</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-3 py-1 bg-red-100 text-red-700 text-sm font-medium rounded-full"
                            id="headerTotalCount">
                            {{ low_credit_count|default(14) }} Total
                        </span>
                        <button class="p-2 hover:bg-white rounded-lg transition-colors" title="Refresh">
                            <i class="fas fa-sync-alt text-gray-500"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Learners List -->
            <div class="max-h-96 overflow-y-auto">
                {% if learners_with_low_grades %}
                {% for learner in learners_with_low_grades %}
                <div
                    class="px-6 py-4 border-b border-gray-100 hover:bg-gradient-to-r hover:from-red-25 hover:to-orange-25 hover:shadow-md hover:border-red-200 transition-all duration-200 cursor-pointer group"
                    onclick="window.open('/learner/{{ learner.User_ID }}', '_blank')"
                    title="Click to view {{ learner.Name }}'s profile in new tab">
                    <div class="flex items-start space-x-4">
                        <!-- Avatar -->
                        <div
                            class="w-12 h-12 bg-gradient-to-br from-red-400 to-orange-500 rounded-xl flex items-center justify-center flex-shrink-0 group-hover:scale-105 transition-transform">
                            <span class="text-white font-bold text-sm">{{ learner.Name.split()[0][0] }}{{
                                learner.Name.split()[-1][0] if learner.Name.split()|length > 1 else '' }}</span>
                        </div>

                        <!-- Main Content -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-2">
                                <h3
                                    class="text-sm font-semibold text-gray-800 group-hover:text-red-700 transition-colors">
                                    {{ learner.Name }}</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">{{
                                        learner.Slot }}</span>
                                    <button
                                        class="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-100 rounded transition-all"
                                        onclick="event.stopPropagation(); window.open('/learner/{{ learner.User_ID }}', '_blank')"
                                        title="View {{ learner.Name }}'s Profile in New Tab">
                                        <i class="fas fa-eye text-red-600 text-xs"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="flex items-center space-x-4 mb-2">
                                <span class="text-xs text-gray-500">
                                    <i class="fas fa-users mr-1"></i>Cohort {{ learner.Cohort }}
                                </span>
                                <span class="text-xs px-2 py-1 rounded-full
                                           {% if learner.Status == 'Active' %}bg-green-100 text-green-700
                                           {% elif learner.Status == 'In Progress' %}bg-yellow-100 text-yellow-700
                                           {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ learner.Status }}
                                </span>
                                <span class="text-xs text-red-600 font-medium">
                                    <i class="fas fa-exclamation-circle mr-1"></i>{{ learner['Number of Courses'] }}
                                    course{{ 's' if learner['Number of Courses'] != 1 else '' }}
                                </span>
                            </div>

                            <!-- Course Details -->
                            <div
                                class="bg-gradient-to-r from-red-50 to-orange-50 rounded-xl p-4 mt-3 border-l-4 border-red-400">
                                <div class="flex items-center mb-2">
                                    <div class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center mr-2">
                                        <i class="fas fa-exclamation text-white text-xs"></i>
                                    </div>
                                    <p class="text-sm text-red-700 font-semibold">
                                        Courses Needing Attention
                                    </p>
                                </div>
                                <div class="ml-8">
                                    {% set courses = learner['FormattedCourses'].split(';') %}
                                    {% for course in courses %}
                                    {% if course.strip() %}
                                    <div
                                        class="flex items-center justify-between bg-white rounded-lg px-3 py-2 mb-2 shadow-sm border border-red-100">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                            <span class="text-sm font-medium text-gray-800">{{
                                                course.split(':')[0].strip() if ':' in course else course.strip()
                                                }}</span>
                                        </div>
                                        {% if ':' in course %}
                                        <div class="flex items-center space-x-2">
                                            {% set grade_credit = course.split(':')[1].strip() if ':' in course else ''
                                            %}
                                            {% if ',' in grade_credit %}
                                            {% set grade = grade_credit.split(',')[0].strip() %}
                                            {% set credit = grade_credit.split(',')[1].strip() %}
                                            <span
                                                class="px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-full">{{
                                                grade }}</span>
                                            <span class="text-xs text-gray-500">{{ credit }}</span>
                                            {% else %}
                                            <span
                                                class="px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-full">{{
                                                grade_credit }}</span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="px-6 py-12 text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Excellent Performance!</h3>
                    <p class="text-gray-600">All learners are performing well and meeting academic standards.</p>
                </div>
                {% endif %}
            </div>

            <!-- Pagination Footer -->
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
                <div class="flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Show</span>
                        <select id="entriesPerPage"
                            class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="30">30</option>
                        </select>
                        <span class="text-sm text-gray-600">entries</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="text-sm text-gray-600">
                            Showing <span class="font-medium" id="showingStart">1</span>
                            to <span class="font-medium" id="showingEnd">10</span>
                            of <span class="font-medium" id="totalEntries">{{ low_credit_count|default(14) }}</span>
                            learners
                        </p>
                    </div>
                    <div class="flex space-x-2" id="paginationControls">
                        <button id="prevBtn"
                            class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled onclick="changePage(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="px-3 py-1 bg-blue-600 text-white rounded-lg" id="currentPageBtn">1</button>
                        <button id="nextBtn"
                            class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors"
                            onclick="changePage(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Database Upload Modal -->
{% if session.get('role') == 'admin' %}
<div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0"
        id="modalContent">
        <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-t-2xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-database text-2xl"></i>
                    <h3 class="text-xl font-bold">Upload Database</h3>
                </div>
                <button onclick="closeUploadModal()" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <div class="p-6">
            <!-- Success/Error Messages will appear here -->
            <div id="modalMessage" class="hidden mb-4"></div>

            <div class="mb-4">
                <div class="flex items-start space-x-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                    <div class="text-sm text-blue-700">
                        <p class="font-medium mb-2">Upload Instructions:</p>
                        <ul class="list-disc list-inside space-y-1 text-xs">
                            <li>File must be in Excel format (.xlsx)</li>
                            <li>Ensure proper column headers</li>
                            <li>Data will replace existing records</li>
                        </ul>
                    </div>
                </div>
            </div>

            <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Excel File</label>
                    <input type="file" id="fileInput" name="file" accept=".xlsx,.xls"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200 hover:border-orange-300">
                </div>

                <!-- Progress Bar -->
                <div id="progressContainer" class="hidden mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>Uploading...</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar"
                            class="bg-gradient-to-r from-orange-500 to-red-500 h-2 rounded-full transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button type="button" onclick="closeUploadModal()"
                        class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="submitBtn"
                        class="flex-1 bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-3 rounded-lg hover:from-orange-600 hover:to-red-600 transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-upload mr-2"></i>
                        <span id="submitText">Upload</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
    // Modal Functions
    function openUploadModal() {
        const modal = document.getElementById('uploadModal');
        const modalContent = document.getElementById('modalContent');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeUploadModal() {
        const modal = document.getElementById('uploadModal');
        const modalContent = document.getElementById('modalContent');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            // Reset form
            document.getElementById('uploadForm').reset();
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('modalMessage').classList.add('hidden');
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitText').textContent = 'Upload';
        }, 300);
    }

    // Close modal when clicking outside
    document.getElementById('uploadModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeUploadModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeUploadModal();
        }
    });

    // Test server connectivity
    async function testServerConnection() {
        try {
            const response = await fetch('/admin/test-upload');
            const result = await response.json();
            console.log('Server test result:', result);
            if (result.success) {
                console.log('✅ Server is responding correctly');
                return true;
            }
        } catch (error) {
            console.error('❌ Server connection test failed:', error);
            return false;
        }
    }

    // Form submission
    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (!file) {
            showModalMessage('error', 'Error', 'Please select a file to upload.');
            return;
        }

        // Test server connection first
        console.log('Testing server connection...');
        const serverOk = await testServerConnection();
        if (!serverOk) {
            showModalMessage('error', 'Connection Error', 'Cannot connect to server. Please check if the server is running and try again.');
            return;
        }

        const formData = new FormData();
        formData.append('database_file', file);

        // Show progress
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');

        progressContainer.classList.remove('hidden');
        submitBtn.disabled = true;
        submitText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
            progressText.textContent = Math.round(progress) + '%';
        }, 200);

        try {
            // Create AbortController for timeout handling
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout

            const response = await fetch('/admin/upload-database', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            progressText.textContent = '100%';

            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);

            if (!response.ok) {
                const errorText = await response.text();
                console.log('Error response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log('Upload result:', result);

            if (result.success) {
                showModalMessage('success', 'Success!', result.message);
                // Reset form
                fileInput.value = '';
                // Note: fileName element doesn't exist in the modal, so we skip that reset
                setTimeout(() => {
                    closeUploadModal();
                }, 3000);
            } else {
                showModalMessage('error', 'Error', result.message);
            }
        } catch (error) {
            clearInterval(progressInterval);
            console.error('Upload error:', error);

            let errorMessage = 'Network error occurred. Please try again.';

            if (error.name === 'AbortError') {
                errorMessage = 'Upload timed out. The file may be too large or the server is busy. Please try again.';
            } else if (error.message.includes('ERR_UPLOAD_FILE_CHANGED')) {
                errorMessage = 'File was modified during upload. Please ensure the file is not open in another application and try again.';
            } else if (error.message.includes('HTTP error')) {
                errorMessage = 'Server error occurred. Please check the file format and try again.';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Connection lost during upload. The database may have been updated successfully. Please refresh the page to check.';
            }

            showModalMessage('error', 'Error', errorMessage);
        } finally {
            submitBtn.disabled = false;
            submitText.textContent = 'Upload';
            setTimeout(() => {
                progressContainer.classList.add('hidden');
            }, 1000);
        }
    });

    function showModalMessage(type, title, message) {
        const messageDiv = document.getElementById('modalMessage');
        const bgColor = type === 'success' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
        const textColor = type === 'success' ? 'text-green-800' : 'text-red-800';
        const iconColor = type === 'success' ? 'text-green-500' : 'text-red-500';
        const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-times-circle';

        messageDiv.innerHTML = `
        <div class="flex items-start space-x-3 p-4 ${bgColor} rounded-lg border">
            <i class="${icon} ${iconColor} mt-0.5"></i>
            <div class="${textColor}">
                <p class="font-medium">${title}</p>
                <p class="text-sm mt-1">${message}</p>
            </div>
        </div>
    `;
        messageDiv.classList.remove('hidden');

        if (type === 'success') {
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000);
        }
    }

    // Pagination functionality for Learners Needing Attention
    let currentPageNum = 1;
    let entriesPerPage = 10;
    let allLearners = [];

    // Initialize pagination when page loads
    document.addEventListener('DOMContentLoaded', function () {
        // Get all learner entries - more specific selector to avoid conflicts
        const learnerEntries = document.querySelectorAll('.max-h-96 .px-6.py-4.border-b.border-gray-100');
        allLearners = Array.from(learnerEntries);

        console.log(`Found ${allLearners.length} learner entries for pagination`);

        // Set up entries per page selector
        const entriesSelect = document.getElementById('entriesPerPage');
        if (entriesSelect) {
            entriesSelect.addEventListener('change', function () {
                entriesPerPage = parseInt(this.value);
                currentPageNum = 1;
                updatePagination();
            });
        }

        updatePagination();
    });

    function updatePagination() {
        const totalEntries = allLearners.length;
        const totalPages = Math.ceil(totalEntries / entriesPerPage);

        // Calculate showing range
        const startIndex = (currentPageNum - 1) * entriesPerPage;
        const endIndex = Math.min(startIndex + entriesPerPage, totalEntries);

        // Update display elements
        const totalEntriesSpan = document.getElementById('totalEntries');
        const showingStartSpan = document.getElementById('showingStart');
        const showingEndSpan = document.getElementById('showingEnd');
        const currentPageBtn = document.getElementById('currentPageBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        if (totalEntriesSpan) totalEntriesSpan.textContent = totalEntries;
        if (showingStartSpan) showingStartSpan.textContent = totalEntries > 0 ? startIndex + 1 : 0;
        if (showingEndSpan) showingEndSpan.textContent = endIndex;
        if (currentPageBtn) currentPageBtn.textContent = currentPageNum;

        // Update button states
        if (prevBtn) {
            prevBtn.disabled = currentPageNum === 1;
        }
        if (nextBtn) {
            nextBtn.disabled = currentPageNum === totalPages || totalPages === 0;
        }

        // Show/hide learner entries
        allLearners.forEach((learner, index) => {
            if (index >= startIndex && index < endIndex) {
                learner.style.display = 'block';
            } else {
                learner.style.display = 'none';
            }
        });

        // Update total count in header
        const headerTotalCount = document.getElementById('headerTotalCount');
        if (headerTotalCount) {
            headerTotalCount.textContent = `${totalEntries} Total`;
        }

        // Generate page numbers (similar to learners page)
        generatePageNumbers(totalPages);
    }

    function generatePageNumbers(totalPages) {
        const paginationControls = document.getElementById('paginationControls');
        if (!paginationControls) return;

        // Clear existing page numbers (keep prev/next buttons)
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        paginationControls.innerHTML = '';

        // Add prev button
        paginationControls.appendChild(prevBtn);

        // Add page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPageNum) {
                const currentBtn = document.createElement('button');
                currentBtn.className = 'px-3 py-1 bg-blue-600 text-white rounded-lg';
                currentBtn.textContent = i;
                currentBtn.id = 'currentPageBtn';
                paginationControls.appendChild(currentBtn);
            } else if (i <= 3 || i > totalPages - 3 || (i >= currentPageNum - 1 && i <= currentPageNum + 1)) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors';
                pageBtn.textContent = i;
                pageBtn.onclick = () => navigateToPage(i);
                paginationControls.appendChild(pageBtn);
            } else if (i === 4 || i === totalPages - 3) {
                const dots = document.createElement('span');
                dots.className = 'px-3 py-1';
                dots.textContent = '...';
                paginationControls.appendChild(dots);
            }
        }

        // Add next button
        paginationControls.appendChild(nextBtn);
    }

    function navigateToPage(pageNum) {
        currentPageNum = pageNum;
        updatePagination();
    }

    function changePage(direction) {
        const totalPages = Math.ceil(allLearners.length / entriesPerPage);

        if (direction === 1 && currentPageNum < totalPages) {
            currentPageNum++;
        } else if (direction === -1 && currentPageNum > 1) {
            currentPageNum--;
        }

        updatePagination();
    }
</script>

{% endblock %}